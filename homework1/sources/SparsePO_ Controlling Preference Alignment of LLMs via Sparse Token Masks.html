<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks</title>
<!--Generated on Mon Oct  7 14:51:00 2024 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="https://arxiv.org/static/browse/0.3.4/css/ar5iv.0.7.9.min.css" rel="stylesheet" type="text/css">
<link href="https://arxiv.org/static/browse/0.3.4/css/ar5iv-fonts.0.7.9.min.css" rel="stylesheet" type="text/css">
<link href="https://arxiv.org/static/browse/0.3.4/css/latexml_styles.css" rel="stylesheet" type="text/css">




<base href="https://arxiv.org/html/2410.05102v1/"></head>
<body>
<nav class="ltx_page_navbar">
<nav class="ltx_TOC">
<ol class="ltx_toclist">
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S1" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">1</span> </span>Introduction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S2" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">2</span> </span>Methodology</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S2.SS1" title="In 2 Methodology ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">2.1</span> </span>Preference Optimization</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S2.SS2" title="In 2 Methodology ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">2.2</span> </span>Sparse Preference Optimization</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S2.SS3" title="In 2 Methodology ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">2.3</span> </span>Mask Computation</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3</span> </span>Experiments</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3.SS1" title="In 3 Experiments ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3.1</span> </span>Model Comparison</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3.SS2" title="In 3 Experiments ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3.2</span> </span>Sentiment Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3.SS3" title="In 3 Experiments ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3.3</span> </span>Helpfulness &amp; Harmlessness Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3.SS4" title="In 3 Experiments ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3.4</span> </span>Summary Quality Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S3.SS5" title="In 3 Experiments ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">3.5</span> </span>Text-to-Code Generation</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S4" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">4</span> </span>Related Work</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S5" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">5</span> </span>Discussion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#S6" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">6</span> </span>Conclusion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A1" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text">A</span> </span><span class="ltx_text ltx_font_typewriter">Mathematical Derivations</span></span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A1.SS1" title="In Appendix A Mathematical Derivations ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">A.1</span> </span>Obtaining the Optimal Policy</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A1.SS2" title="In Appendix A Mathematical Derivations ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">A.2</span> </span>Deriving the SparsePO Objective from the Bradley-Terry Equivalence</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text">B</span> </span><span class="ltx_text ltx_font_typewriter">Details on Experimental Setup</span></span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2.SS1" title="In Appendix B Details on Experimental Setup ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">B.1</span> </span>Release</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2.SS2" title="In Appendix B Details on Experimental Setup ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">B.2</span> </span>Sentiment Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2.SS3" title="In Appendix B Details on Experimental Setup ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">B.3</span> </span>Summary Quality Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2.SS4" title="In Appendix B Details on Experimental Setup ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">B.4</span> </span>Helpfulness &amp; Harmlessness Control</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A2.SS5" title="In Appendix B Details on Experimental Setup ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">B.5</span> </span>Text-to-Code Generation</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A3" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text">C</span> </span><span class="ltx_text ltx_font_typewriter">Complementary Results</span></span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A3.SS1" title="In Appendix C Complementary Results ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">C.1</span> </span>Sparsity and Token-level KL Divergence</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A3.SS2" title="In Appendix C Complementary Results ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">C.2</span> </span>Qualitative Analysis</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A4" title="In SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text">D</span> </span><span class="ltx_text ltx_font_typewriter">Ablation Studies</span></span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A4.SS1" title="In Appendix D Ablation Studies ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">D.1</span> </span>Mask Architecture</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A4.SS2" title="In Appendix D Ablation Studies ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">D.2</span> </span>Hyper-Parameter Tuning</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#A4.SS3" title="In Appendix D Ablation Studies ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref"><span class="ltx_text ltx_font_serif">D.3</span> </span>Binary and Random Masks</span></a></li>
</ol>
</li>
</ol></nav>
</nav>
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document ltx_authors_1line">
<h1 class="ltx_title ltx_title_document">SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Fenia Christopoulou
</span><span class="ltx_author_notes"><sup class="ltx_sup" id="id2.2.id1">∗</sup>Equal Contribution.
<span class="ltx_contact ltx_role_affiliation">Huawei Noah’s Ark Lab, London, UK
</span>
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Ronald Cardenas
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">Huawei Noah’s Ark Lab, London, UK
</span>
<span class="ltx_contact ltx_role_affiliation">
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Gerasimos Lampouras
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">Huawei Noah’s Ark Lab, London, UK
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">
<br class="ltx_break"><span class="ltx_text ltx_font_bold" id="id3.1.id1">Haitham Bou-Ammar</span>
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">Huawei Noah’s Ark Lab, London, UK
</span>
<span class="ltx_contact ltx_role_affiliation">University College London, UK
</span></span></span>
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Jun Wang
</span><span class="ltx_author_notes">
<span class="ltx_contact ltx_role_affiliation">University College London, UK
</span></span></span>
</div>
<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p" id="id4.id1"><span class="ltx_text ltx_font_typewriter" id="id4.id1.1">Preference Optimization (PO) has proven an effective step for aligning language models to human-desired behaviors. Current variants, following the offline Direct Preference Optimization objective, have focused on a strict setting where all tokens are contributing signals of KL divergence and rewards to the loss function. However, human preference is not affected by each word in a sequence equally but is often dependent on specific words or phrases, e.g. existence of toxic terms leads to non-preferred responses.
Based on this observation, we argue that not all tokens should be weighted equally during PO and propose a flexible objective termed SparsePO, that aims to automatically learn to weight the KL divergence and reward corresponding to each token during PO training. We propose two different variants of weight-masks that can either be derived from the reference model itself or learned on the fly.
Notably, our method induces sparsity in the learned masks, allowing the model to learn how to best weight reward and KL divergence contributions at the token level, learning an optimal level of mask sparsity.
Extensive experiments on multiple domains, including sentiment control, dialogue, text summarization and text-to-code generation, illustrate that our approach assigns meaningful weights to tokens according to the target task, generates more responses with the desired preference and improves reasoning tasks by up to 2 percentage points compared to other token- and response-level PO methods.</span></p>
</div>
<section class="ltx_section" id="S1">
<h2 class="ltx_title ltx_font_typewriter ltx_title_section">
<span class="ltx_tag ltx_tag_section"><span class="ltx_text ltx_font_serif" id="S1.1.1.1">1</span> </span>Introduction</h2>
<div class="ltx_para ltx_noindent" id="S1.p1">
<p class="ltx_p" id="S1.p1.1"><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.1">The rise of employing Large Language Models (LLMs) as conversational agents has increased the importance of aligning them with human preferences. Preference Optimization (PO), i.e. the training paradigm that aims to steer models to a desired behavior (typically related to human perception), is considered the last and most important step in the pipeline of LLM training for producing accurate, harmless and controllable models.
Reinforcement Learning from Human Feedback (RLHF;&nbsp;</span><cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_text ltx_font_typewriter">Christiano et&nbsp;al.</span> <span class="ltx_text ltx_font_typewriter" id="S1.p1.1.2.1.1.1">(</span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib7" title=""><span class="ltx_text ltx_font_typewriter">2017</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.3.2.2.1">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.4">) was the primary method for obtaining such a behavior. However, due to it’s inherent complexity it has been overpowered by Direct Preference Optimization (DPO)&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.5.1">(</span><span class="ltx_text ltx_font_typewriter">Rafailov et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.6.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib28" title=""><span class="ltx_text ltx_font_typewriter">2023</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.7.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p1.1.8">, a simpler, offline approach that produces a policy model that fits the preference data without the need for reinforcement learning.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p2">
<p class="ltx_p" id="S1.p2.1"><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.1">DPO performs at the sequence level, optimizing rewards and measuring KL divergence for complete responses. However, various studies have shown that signals from specific tokens are primarily responsible for learning desired behaviors, both during pre-training&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.2.1">(</span><span class="ltx_text ltx_font_typewriter">Lin et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.3.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib20" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.4.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.5"> and preference optimization&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.6.1">(</span><span class="ltx_text ltx_font_typewriter">Yang et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.7.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib35" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.8.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.9">.
In particular, in domains where the preference is determined by a specific aspect (e.g. sentiment, toxicity) or when the decision relies on certain subsequences&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.10.1">(</span><span class="ltx_text ltx_font_typewriter">Pal et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.11.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib26" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.12.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.13">, it is necessary to consider more fine-grained updates. To further illustrate this point, Figure </span><a class="ltx_ref ltx_font_typewriter" href="https://arxiv.org/html/2410.05102v1#S1.F1" title="Figure 1 ‣ 1 Introduction ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_tag">1</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.14"> shows that DPO is already learning implicitly to assign different token-level rewards, with higher values on a few tokens with positive/negative polarity (e.g. </span><span class="ltx_text ltx_font_italic" id="S1.p2.1.15">pretty</span><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.16">, </span><span class="ltx_text ltx_font_italic" id="S1.p2.1.17">weak</span><span class="ltx_text ltx_font_typewriter" id="S1.p2.1.18">).
However, noting the various lone tokens with high rewards, DPO’s reward distribution seems inconsistent, and we posit that it would benefit from a more explicit signal.</span></p>
</div>
<figure class="ltx_figure" id="S1.F1">
<div class="ltx_flex_figure">
<div class="ltx_flex_cell ltx_flex_size_1"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_figure_panel ltx_img_landscape" height="31" id="S1.F1.g1" src="https://arxiv.org/html/2410.05102v1/extracted/5902342/dpo_imdb_chosen_rew.png" width="568"></div>
<div class="ltx_flex_break"></div>
<div class="ltx_flex_cell ltx_flex_size_1"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_figure_panel ltx_img_landscape" height="52" id="S1.F1.g2" src="https://arxiv.org/html/2410.05102v1/extracted/5902342/dpo_imdb_rejected_rew.png" width="568"></div>
</div>
<figcaption class="ltx_caption ltx_centering ltx_font_typewriter"><span class="ltx_tag ltx_tag_figure"><span class="ltx_text ltx_font_serif" id="S1.F1.3.1.1">Figure 1</span>: </span>Token-level rewards for chosen (top) and rejected (bottom) responses given an input prompt. After a GPT2-Large model is trained with DPO on the IMDB dataset to generate positive movies reviews, these rewards are calculated as the log ratio of token probabilities between policy (DPO) and reference model (original GPT2-Large). Denser values indicate higher probability score assigned to a token by the policy than the reference, implying importance towards that preference.</figcaption>
</figure>
<div class="ltx_para ltx_noindent" id="S1.p3">
<p class="ltx_p" id="S1.p3.1"><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.1">Aligned with prior work, we argue that not all tokens are important in preference optimization. We further propose that in order to have more diverse responses, and flexible optimization, we should allow only certain tokens to be close to the reference model so that the rest are able to grow beyond it--dismissing the need for measuring KL divergence on all tokens.
As such, in this work we propose sparse token-level preference optimization (</span><span class="ltx_text ltx_font_smallcaps" id="S1.p3.1.2">SparsePO</span><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.3">), a method that learns automatically during training inherently sparse masks over token-level rewards and KL divergences.
Approaches that have been developed based on this observation, either use external models to identify important tokens&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.4.1">(</span><span class="ltx_text ltx_font_typewriter">Yoon et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.5.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib36" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.6.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.7"> or need to first perform DPO training to select high-rewardable tokens&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.8.1">(</span><span class="ltx_text ltx_font_typewriter">Yang et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.9.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib35" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.10.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S1.p3.1.11">.
Our method targets flexibility, with masks that can be either shared or independent between rewards and KL divergence. In addition, it is not reliant on external models and can be combined with any possible masking method. In this work, we present two masking strategies but any masking over tokens can be used instead.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S1.p4">
<p class="ltx_p" id="S1.p4.1"><span class="ltx_text ltx_font_typewriter" id="S1.p4.1.1">Our contributions include (1) a flexible framework, termed SparsePO, for weighting token-level reward and KL contributions tailored to the offline preference optimization objective, (2) analyses over the induced masks’ sparsity and reward frontier and how they correlate with controlled KL divergence, (3) quantitative and qualitative gains when employing our proposed approach to different domains with explicit or implicit preference indicators.</span></p>
</div>
</section>
<section class="ltx_section" id="S2">
<h2 class="ltx_title ltx_font_typewriter ltx_title_section">
<span class="ltx_tag ltx_tag_section"><span class="ltx_text ltx_font_serif" id="S2.1.1.1">2</span> </span>Methodology</h2>
<section class="ltx_subsection" id="S2.SS1">
<h3 class="ltx_title ltx_font_typewriter ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection"><span class="ltx_text ltx_font_serif" id="S2.SS1.1.1.1">2.1</span> </span>Preference Optimization</h3>
<div class="ltx_para ltx_noindent" id="S2.SS1.p1">
<p class="ltx_p" id="S2.SS1.p1.9"><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.1">The purpose of aligning models with human preferences is to steer model behavior to produce human-acceptable responses.
To realize that, we assume training data in the form of static, paired preferences. A prompt </span><math alttext="x" class="ltx_Math" display="inline" id="S2.SS1.p1.1.m1.1"><semantics id="S2.SS1.p1.1.m1.1a"><mi id="S2.SS1.p1.1.m1.1.1" xref="S2.SS1.p1.1.m1.1.1.cmml">x</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.1.m1.1b"><ci id="S2.SS1.p1.1.m1.1.1.cmml" xref="S2.SS1.p1.1.m1.1.1">𝑥</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.1.m1.1c">x</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.1.m1.1d">italic_x</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.2"> is associated with two responses, chosen </span><math alttext="y_{c}" class="ltx_Math" display="inline" id="S2.SS1.p1.2.m2.1"><semantics id="S2.SS1.p1.2.m2.1a"><msub id="S2.SS1.p1.2.m2.1.1" xref="S2.SS1.p1.2.m2.1.1.cmml"><mi id="S2.SS1.p1.2.m2.1.1.2" xref="S2.SS1.p1.2.m2.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.2.m2.1.1.3" xref="S2.SS1.p1.2.m2.1.1.3.cmml">c</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.2.m2.1b"><apply id="S2.SS1.p1.2.m2.1.1.cmml" xref="S2.SS1.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.2.m2.1.1.1.cmml" xref="S2.SS1.p1.2.m2.1.1">subscript</csymbol><ci id="S2.SS1.p1.2.m2.1.1.2.cmml" xref="S2.SS1.p1.2.m2.1.1.2">𝑦</ci><ci id="S2.SS1.p1.2.m2.1.1.3.cmml" xref="S2.SS1.p1.2.m2.1.1.3">𝑐</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.2.m2.1c">y_{c}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.2.m2.1d">italic_y start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.3"> and rejected </span><math alttext="y_{r}" class="ltx_Math" display="inline" id="S2.SS1.p1.3.m3.1"><semantics id="S2.SS1.p1.3.m3.1a"><msub id="S2.SS1.p1.3.m3.1.1" xref="S2.SS1.p1.3.m3.1.1.cmml"><mi id="S2.SS1.p1.3.m3.1.1.2" xref="S2.SS1.p1.3.m3.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.3.m3.1.1.3" xref="S2.SS1.p1.3.m3.1.1.3.cmml">r</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.3.m3.1b"><apply id="S2.SS1.p1.3.m3.1.1.cmml" xref="S2.SS1.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.3.m3.1.1.1.cmml" xref="S2.SS1.p1.3.m3.1.1">subscript</csymbol><ci id="S2.SS1.p1.3.m3.1.1.2.cmml" xref="S2.SS1.p1.3.m3.1.1.2">𝑦</ci><ci id="S2.SS1.p1.3.m3.1.1.3.cmml" xref="S2.SS1.p1.3.m3.1.1.3">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.3.m3.1c">y_{r}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.3.m3.1d">italic_y start_POSTSUBSCRIPT italic_r end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.4">, so that </span><math alttext="y_{c}" class="ltx_Math" display="inline" id="S2.SS1.p1.4.m4.1"><semantics id="S2.SS1.p1.4.m4.1a"><msub id="S2.SS1.p1.4.m4.1.1" xref="S2.SS1.p1.4.m4.1.1.cmml"><mi id="S2.SS1.p1.4.m4.1.1.2" xref="S2.SS1.p1.4.m4.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.4.m4.1.1.3" xref="S2.SS1.p1.4.m4.1.1.3.cmml">c</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.4.m4.1b"><apply id="S2.SS1.p1.4.m4.1.1.cmml" xref="S2.SS1.p1.4.m4.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.4.m4.1.1.1.cmml" xref="S2.SS1.p1.4.m4.1.1">subscript</csymbol><ci id="S2.SS1.p1.4.m4.1.1.2.cmml" xref="S2.SS1.p1.4.m4.1.1.2">𝑦</ci><ci id="S2.SS1.p1.4.m4.1.1.3.cmml" xref="S2.SS1.p1.4.m4.1.1.3">𝑐</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.4.m4.1c">y_{c}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.4.m4.1d">italic_y start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.5"> is preferred over </span><math alttext="y_{r}" class="ltx_Math" display="inline" id="S2.SS1.p1.5.m5.1"><semantics id="S2.SS1.p1.5.m5.1a"><msub id="S2.SS1.p1.5.m5.1.1" xref="S2.SS1.p1.5.m5.1.1.cmml"><mi id="S2.SS1.p1.5.m5.1.1.2" xref="S2.SS1.p1.5.m5.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.5.m5.1.1.3" xref="S2.SS1.p1.5.m5.1.1.3.cmml">r</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.5.m5.1b"><apply id="S2.SS1.p1.5.m5.1.1.cmml" xref="S2.SS1.p1.5.m5.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.5.m5.1.1.1.cmml" xref="S2.SS1.p1.5.m5.1.1">subscript</csymbol><ci id="S2.SS1.p1.5.m5.1.1.2.cmml" xref="S2.SS1.p1.5.m5.1.1.2">𝑦</ci><ci id="S2.SS1.p1.5.m5.1.1.3.cmml" xref="S2.SS1.p1.5.m5.1.1.3">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.5.m5.1c">y_{r}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.5.m5.1d">italic_y start_POSTSUBSCRIPT italic_r end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.6"> (</span><math alttext="y_{c}\succ y_{r}|x" class="ltx_Math" display="inline" id="S2.SS1.p1.6.m6.1"><semantics id="S2.SS1.p1.6.m6.1a"><mrow id="S2.SS1.p1.6.m6.1.1" xref="S2.SS1.p1.6.m6.1.1.cmml"><msub id="S2.SS1.p1.6.m6.1.1.2" xref="S2.SS1.p1.6.m6.1.1.2.cmml"><mi id="S2.SS1.p1.6.m6.1.1.2.2" xref="S2.SS1.p1.6.m6.1.1.2.2.cmml">y</mi><mi id="S2.SS1.p1.6.m6.1.1.2.3" xref="S2.SS1.p1.6.m6.1.1.2.3.cmml">c</mi></msub><mo id="S2.SS1.p1.6.m6.1.1.1" xref="S2.SS1.p1.6.m6.1.1.1.cmml">≻</mo><mrow id="S2.SS1.p1.6.m6.1.1.3" xref="S2.SS1.p1.6.m6.1.1.3.cmml"><msub id="S2.SS1.p1.6.m6.1.1.3.2" xref="S2.SS1.p1.6.m6.1.1.3.2.cmml"><mi id="S2.SS1.p1.6.m6.1.1.3.2.2" xref="S2.SS1.p1.6.m6.1.1.3.2.2.cmml">y</mi><mi id="S2.SS1.p1.6.m6.1.1.3.2.3" xref="S2.SS1.p1.6.m6.1.1.3.2.3.cmml">r</mi></msub><mo fence="false" id="S2.SS1.p1.6.m6.1.1.3.1" xref="S2.SS1.p1.6.m6.1.1.3.1.cmml">|</mo><mi id="S2.SS1.p1.6.m6.1.1.3.3" xref="S2.SS1.p1.6.m6.1.1.3.3.cmml">x</mi></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.6.m6.1b"><apply id="S2.SS1.p1.6.m6.1.1.cmml" xref="S2.SS1.p1.6.m6.1.1"><csymbol cd="latexml" id="S2.SS1.p1.6.m6.1.1.1.cmml" xref="S2.SS1.p1.6.m6.1.1.1">succeeds</csymbol><apply id="S2.SS1.p1.6.m6.1.1.2.cmml" xref="S2.SS1.p1.6.m6.1.1.2"><csymbol cd="ambiguous" id="S2.SS1.p1.6.m6.1.1.2.1.cmml" xref="S2.SS1.p1.6.m6.1.1.2">subscript</csymbol><ci id="S2.SS1.p1.6.m6.1.1.2.2.cmml" xref="S2.SS1.p1.6.m6.1.1.2.2">𝑦</ci><ci id="S2.SS1.p1.6.m6.1.1.2.3.cmml" xref="S2.SS1.p1.6.m6.1.1.2.3">𝑐</ci></apply><apply id="S2.SS1.p1.6.m6.1.1.3.cmml" xref="S2.SS1.p1.6.m6.1.1.3"><csymbol cd="latexml" id="S2.SS1.p1.6.m6.1.1.3.1.cmml" xref="S2.SS1.p1.6.m6.1.1.3.1">conditional</csymbol><apply id="S2.SS1.p1.6.m6.1.1.3.2.cmml" xref="S2.SS1.p1.6.m6.1.1.3.2"><csymbol cd="ambiguous" id="S2.SS1.p1.6.m6.1.1.3.2.1.cmml" xref="S2.SS1.p1.6.m6.1.1.3.2">subscript</csymbol><ci id="S2.SS1.p1.6.m6.1.1.3.2.2.cmml" xref="S2.SS1.p1.6.m6.1.1.3.2.2">𝑦</ci><ci id="S2.SS1.p1.6.m6.1.1.3.2.3.cmml" xref="S2.SS1.p1.6.m6.1.1.3.2.3">𝑟</ci></apply><ci id="S2.SS1.p1.6.m6.1.1.3.3.cmml" xref="S2.SS1.p1.6.m6.1.1.3.3">𝑥</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.6.m6.1c">y_{c}\succ y_{r}|x</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.6.m6.1d">italic_y start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT ≻ italic_y start_POSTSUBSCRIPT italic_r end_POSTSUBSCRIPT | italic_x</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.7">), resulting in a dataset </span><math alttext="D=\{x^{(i)},y_{c}^{(i)},y_{r}^{(i)}\}_{i=1}^{N}" class="ltx_Math" display="inline" id="S2.SS1.p1.7.m7.6"><semantics id="S2.SS1.p1.7.m7.6a"><mrow id="S2.SS1.p1.7.m7.6.6" xref="S2.SS1.p1.7.m7.6.6.cmml"><mi id="S2.SS1.p1.7.m7.6.6.5" xref="S2.SS1.p1.7.m7.6.6.5.cmml">D</mi><mo id="S2.SS1.p1.7.m7.6.6.4" xref="S2.SS1.p1.7.m7.6.6.4.cmml">=</mo><msubsup id="S2.SS1.p1.7.m7.6.6.3" xref="S2.SS1.p1.7.m7.6.6.3.cmml"><mrow id="S2.SS1.p1.7.m7.6.6.3.3.3.3" xref="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml"><mo id="S2.SS1.p1.7.m7.6.6.3.3.3.3.4" stretchy="false" xref="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml">{</mo><msup id="S2.SS1.p1.7.m7.4.4.1.1.1.1.1" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.cmml"><mi id="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.2" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.2.cmml">x</mi><mrow id="S2.SS1.p1.7.m7.1.1.1.3" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.cmml"><mo id="S2.SS1.p1.7.m7.1.1.1.3.1" stretchy="false" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.cmml">(</mo><mi id="S2.SS1.p1.7.m7.1.1.1.1" xref="S2.SS1.p1.7.m7.1.1.1.1.cmml">i</mi><mo id="S2.SS1.p1.7.m7.1.1.1.3.2" stretchy="false" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.cmml">)</mo></mrow></msup><mo id="S2.SS1.p1.7.m7.6.6.3.3.3.3.5" xref="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml">,</mo><msubsup id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.cmml"><mi id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.2" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.2.cmml">y</mi><mi id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.3" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.3.cmml">c</mi><mrow id="S2.SS1.p1.7.m7.2.2.1.3" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.cmml"><mo id="S2.SS1.p1.7.m7.2.2.1.3.1" stretchy="false" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.cmml">(</mo><mi id="S2.SS1.p1.7.m7.2.2.1.1" xref="S2.SS1.p1.7.m7.2.2.1.1.cmml">i</mi><mo id="S2.SS1.p1.7.m7.2.2.1.3.2" stretchy="false" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.cmml">)</mo></mrow></msubsup><mo id="S2.SS1.p1.7.m7.6.6.3.3.3.3.6" xref="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml">,</mo><msubsup id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.cmml"><mi id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.2" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.2.cmml">y</mi><mi id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.3" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.3.cmml">r</mi><mrow id="S2.SS1.p1.7.m7.3.3.1.3" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.cmml"><mo id="S2.SS1.p1.7.m7.3.3.1.3.1" stretchy="false" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.cmml">(</mo><mi id="S2.SS1.p1.7.m7.3.3.1.1" xref="S2.SS1.p1.7.m7.3.3.1.1.cmml">i</mi><mo id="S2.SS1.p1.7.m7.3.3.1.3.2" stretchy="false" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.cmml">)</mo></mrow></msubsup><mo id="S2.SS1.p1.7.m7.6.6.3.3.3.3.7" stretchy="false" xref="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml">}</mo></mrow><mrow id="S2.SS1.p1.7.m7.6.6.3.3.5" xref="S2.SS1.p1.7.m7.6.6.3.3.5.cmml"><mi id="S2.SS1.p1.7.m7.6.6.3.3.5.2" xref="S2.SS1.p1.7.m7.6.6.3.3.5.2.cmml">i</mi><mo id="S2.SS1.p1.7.m7.6.6.3.3.5.1" xref="S2.SS1.p1.7.m7.6.6.3.3.5.1.cmml">=</mo><mn id="S2.SS1.p1.7.m7.6.6.3.3.5.3" xref="S2.SS1.p1.7.m7.6.6.3.3.5.3.cmml">1</mn></mrow><mi id="S2.SS1.p1.7.m7.6.6.3.5" xref="S2.SS1.p1.7.m7.6.6.3.5.cmml">N</mi></msubsup></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.7.m7.6b"><apply id="S2.SS1.p1.7.m7.6.6.cmml" xref="S2.SS1.p1.7.m7.6.6"><eq id="S2.SS1.p1.7.m7.6.6.4.cmml" xref="S2.SS1.p1.7.m7.6.6.4"></eq><ci id="S2.SS1.p1.7.m7.6.6.5.cmml" xref="S2.SS1.p1.7.m7.6.6.5">𝐷</ci><apply id="S2.SS1.p1.7.m7.6.6.3.cmml" xref="S2.SS1.p1.7.m7.6.6.3"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.6.6.3.4.cmml" xref="S2.SS1.p1.7.m7.6.6.3">superscript</csymbol><apply id="S2.SS1.p1.7.m7.6.6.3.3.cmml" xref="S2.SS1.p1.7.m7.6.6.3"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.6.6.3.3.4.cmml" xref="S2.SS1.p1.7.m7.6.6.3">subscript</csymbol><set id="S2.SS1.p1.7.m7.6.6.3.3.3.4.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3"><apply id="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.cmml" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.1.cmml" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1">superscript</csymbol><ci id="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.2.cmml" xref="S2.SS1.p1.7.m7.4.4.1.1.1.1.1.2">𝑥</ci><ci id="S2.SS1.p1.7.m7.1.1.1.1.cmml" xref="S2.SS1.p1.7.m7.1.1.1.1">𝑖</ci></apply><apply id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.1.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2">superscript</csymbol><apply id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.1.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2">subscript</csymbol><ci id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.2.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.2">𝑦</ci><ci id="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.3.cmml" xref="S2.SS1.p1.7.m7.5.5.2.2.2.2.2.2.3">𝑐</ci></apply><ci id="S2.SS1.p1.7.m7.2.2.1.1.cmml" xref="S2.SS1.p1.7.m7.2.2.1.1">𝑖</ci></apply><apply id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.1.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3">superscript</csymbol><apply id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3"><csymbol cd="ambiguous" id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.1.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3">subscript</csymbol><ci id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.2.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.2">𝑦</ci><ci id="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.3.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.3.3.3.2.3">𝑟</ci></apply><ci id="S2.SS1.p1.7.m7.3.3.1.1.cmml" xref="S2.SS1.p1.7.m7.3.3.1.1">𝑖</ci></apply></set><apply id="S2.SS1.p1.7.m7.6.6.3.3.5.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.5"><eq id="S2.SS1.p1.7.m7.6.6.3.3.5.1.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.5.1"></eq><ci id="S2.SS1.p1.7.m7.6.6.3.3.5.2.cmml" xref="S2.SS1.p1.7.m7.6.6.3.3.5.2">𝑖</ci><cn id="S2.SS1.p1.7.m7.6.6.3.3.5.3.cmml" type="integer" xref="S2.SS1.p1.7.m7.6.6.3.3.5.3">1</cn></apply></apply><ci id="S2.SS1.p1.7.m7.6.6.3.5.cmml" xref="S2.SS1.p1.7.m7.6.6.3.5">𝑁</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.7.m7.6c">D=\{x^{(i)},y_{c}^{(i)},y_{r}^{(i)}\}_{i=1}^{N}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.7.m7.6d">italic_D = { italic_x start_POSTSUPERSCRIPT ( italic_i ) end_POSTSUPERSCRIPT , italic_y start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_i ) end_POSTSUPERSCRIPT , italic_y start_POSTSUBSCRIPT italic_r end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_i ) end_POSTSUPERSCRIPT } start_POSTSUBSCRIPT italic_i = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_N end_POSTSUPERSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.8">. Such responses and their rankings are typically collected either by humans or automatically from other models&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.9.1">(</span><span class="ltx_text ltx_font_typewriter">Xu et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.10.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib34" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.11.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.12">.
In PO, we aim to train a model to generate responses closer to </span><math alttext="y_{c}" class="ltx_Math" display="inline" id="S2.SS1.p1.8.m8.1"><semantics id="S2.SS1.p1.8.m8.1a"><msub id="S2.SS1.p1.8.m8.1.1" xref="S2.SS1.p1.8.m8.1.1.cmml"><mi id="S2.SS1.p1.8.m8.1.1.2" xref="S2.SS1.p1.8.m8.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.8.m8.1.1.3" xref="S2.SS1.p1.8.m8.1.1.3.cmml">c</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.8.m8.1b"><apply id="S2.SS1.p1.8.m8.1.1.cmml" xref="S2.SS1.p1.8.m8.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.8.m8.1.1.1.cmml" xref="S2.SS1.p1.8.m8.1.1">subscript</csymbol><ci id="S2.SS1.p1.8.m8.1.1.2.cmml" xref="S2.SS1.p1.8.m8.1.1.2">𝑦</ci><ci id="S2.SS1.p1.8.m8.1.1.3.cmml" xref="S2.SS1.p1.8.m8.1.1.3">𝑐</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.8.m8.1c">y_{c}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.8.m8.1d">italic_y start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.13"> than </span><math alttext="y_{r}" class="ltx_Math" display="inline" id="S2.SS1.p1.9.m9.1"><semantics id="S2.SS1.p1.9.m9.1a"><msub id="S2.SS1.p1.9.m9.1.1" xref="S2.SS1.p1.9.m9.1.1.cmml"><mi id="S2.SS1.p1.9.m9.1.1.2" xref="S2.SS1.p1.9.m9.1.1.2.cmml">y</mi><mi id="S2.SS1.p1.9.m9.1.1.3" xref="S2.SS1.p1.9.m9.1.1.3.cmml">r</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p1.9.m9.1b"><apply id="S2.SS1.p1.9.m9.1.1.cmml" xref="S2.SS1.p1.9.m9.1.1"><csymbol cd="ambiguous" id="S2.SS1.p1.9.m9.1.1.1.cmml" xref="S2.SS1.p1.9.m9.1.1">subscript</csymbol><ci id="S2.SS1.p1.9.m9.1.1.2.cmml" xref="S2.SS1.p1.9.m9.1.1.2">𝑦</ci><ci id="S2.SS1.p1.9.m9.1.1.3.cmml" xref="S2.SS1.p1.9.m9.1.1.3">𝑟</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p1.9.m9.1c">y_{r}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p1.9.m9.1d">italic_y start_POSTSUBSCRIPT italic_r end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p1.9.14">.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S2.SS1.p2">
<p class="ltx_p" id="S2.SS1.p2.3"><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.1">In the standard Reinforcement from Human Feedback (RLHF) pipeline&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.2.1">(</span><span class="ltx_text ltx_font_typewriter">Ziegler et&nbsp;al.</span><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.3.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib40" title=""><span class="ltx_text ltx_font_typewriter">2019</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.4.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.5"> this is realized in a sequence of steps.
Firstly, we perform supervised fine-tuning on the task for which we would like to learn preferences, to shift the distribution of the language model in-domain with the PO data.
Then, a reward model is trained, responsible for assigning a higher score (reward) to chosen responses and lower scores to rejected ones.
Given a policy network </span><math alttext="\pi" class="ltx_Math" display="inline" id="S2.SS1.p2.1.m1.1"><semantics id="S2.SS1.p2.1.m1.1a"><mi id="S2.SS1.p2.1.m1.1.1" xref="S2.SS1.p2.1.m1.1.1.cmml">π</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.1.m1.1b"><ci id="S2.SS1.p2.1.m1.1.1.cmml" xref="S2.SS1.p2.1.m1.1.1">𝜋</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.1.m1.1c">\pi</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.1.m1.1d">italic_π</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.6"> (i.e., the model that we aim to optimize), responses are sampled and then scored by the reward model. The policy training aims to maximize the rewards associated with chosen responses and minimize those of rejected ones, subject to a KL constrain with a reference model </span><math alttext="\pi_{\text{ref}}" class="ltx_Math" display="inline" id="S2.SS1.p2.2.m2.1"><semantics id="S2.SS1.p2.2.m2.1a"><msub id="S2.SS1.p2.2.m2.1.1" xref="S2.SS1.p2.2.m2.1.1.cmml"><mi id="S2.SS1.p2.2.m2.1.1.2" xref="S2.SS1.p2.2.m2.1.1.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS1.p2.2.m2.1.1.3" xref="S2.SS1.p2.2.m2.1.1.3a.cmml">ref</mtext></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.2.m2.1b"><apply id="S2.SS1.p2.2.m2.1.1.cmml" xref="S2.SS1.p2.2.m2.1.1"><csymbol cd="ambiguous" id="S2.SS1.p2.2.m2.1.1.1.cmml" xref="S2.SS1.p2.2.m2.1.1">subscript</csymbol><ci id="S2.SS1.p2.2.m2.1.1.2.cmml" xref="S2.SS1.p2.2.m2.1.1.2">𝜋</ci><ci id="S2.SS1.p2.2.m2.1.1.3a.cmml" xref="S2.SS1.p2.2.m2.1.1.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS1.p2.2.m2.1.1.3.cmml" mathsize="70%" xref="S2.SS1.p2.2.m2.1.1.3">ref</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.2.m2.1c">\pi_{\text{ref}}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.2.m2.1d">italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.7">. The constrain prevents the policy </span><math alttext="\pi" class="ltx_Math" display="inline" id="S2.SS1.p2.3.m3.1"><semantics id="S2.SS1.p2.3.m3.1a"><mi id="S2.SS1.p2.3.m3.1.1" xref="S2.SS1.p2.3.m3.1.1.cmml">π</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.3.m3.1b"><ci id="S2.SS1.p2.3.m3.1.1.cmml" xref="S2.SS1.p2.3.m3.1.1">𝜋</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.3.m3.1c">\pi</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.3.m3.1d">italic_π</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.3.8"> from deviating too much from the distribution that the reward model has learned, as well as avoids reward hacking.
The above process is translated into the following objective.</span></p>
<table class="ltx_equation ltx_eqn_table" id="S2.E1">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="{J}_{\pi}=\max_{\pi}\mathbb{E}\left[r(x,y)\right]-\beta\;D_{\mathrm{KL}}\left[%
\pi(y|x)\|\pi_{\text{ref}}(y|x)\right]," class="ltx_math_unparsed" display="block" id="S2.E1.m1.2"><semantics id="S2.E1.m1.2a"><mrow id="S2.E1.m1.2b"><msub id="S2.E1.m1.2.3"><mi id="S2.E1.m1.2.3.2">J</mi><mi id="S2.E1.m1.2.3.3">π</mi></msub><mo id="S2.E1.m1.2.4">=</mo><munder id="S2.E1.m1.2.5"><mi id="S2.E1.m1.2.5.2">max</mi><mi id="S2.E1.m1.2.5.3">π</mi></munder><mi id="S2.E1.m1.2.6">𝔼</mi><mrow id="S2.E1.m1.2.7"><mo id="S2.E1.m1.2.7.1">[</mo><mi id="S2.E1.m1.2.7.2">r</mi><mrow id="S2.E1.m1.2.7.3"><mo id="S2.E1.m1.2.7.3.1" stretchy="false">(</mo><mi id="S2.E1.m1.1.1">x</mi><mo id="S2.E1.m1.2.7.3.2">,</mo><mi id="S2.E1.m1.2.2">y</mi><mo id="S2.E1.m1.2.7.3.3" stretchy="false">)</mo></mrow><mo id="S2.E1.m1.2.7.4">]</mo></mrow><mo id="S2.E1.m1.2.8">−</mo><mi id="S2.E1.m1.2.9">β</mi><msub id="S2.E1.m1.2.10"><mi id="S2.E1.m1.2.10.2">D</mi><mi id="S2.E1.m1.2.10.3">KL</mi></msub><mrow id="S2.E1.m1.2.11"><mo id="S2.E1.m1.2.11.1">[</mo><mi id="S2.E1.m1.2.11.2">π</mi><mrow id="S2.E1.m1.2.11.3"><mo id="S2.E1.m1.2.11.3.1" stretchy="false">(</mo><mi id="S2.E1.m1.2.11.3.2">y</mi><mo fence="false" id="S2.E1.m1.2.11.3.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E1.m1.2.11.3.4">x</mi><mo id="S2.E1.m1.2.11.3.5" stretchy="false">)</mo></mrow><mo id="S2.E1.m1.2.11.4" lspace="0em" rspace="0.167em">∥</mo><msub id="S2.E1.m1.2.11.5"><mi id="S2.E1.m1.2.11.5.2">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E1.m1.2.11.5.3">ref</mtext></msub><mrow id="S2.E1.m1.2.11.6"><mo id="S2.E1.m1.2.11.6.1" stretchy="false">(</mo><mi id="S2.E1.m1.2.11.6.2">y</mi><mo fence="false" id="S2.E1.m1.2.11.6.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E1.m1.2.11.6.4">x</mi><mo id="S2.E1.m1.2.11.6.5" stretchy="false">)</mo></mrow><mo id="S2.E1.m1.2.11.7">]</mo></mrow><mo id="S2.E1.m1.2.12">,</mo></mrow><annotation encoding="application/x-tex" id="S2.E1.m1.2c">{J}_{\pi}=\max_{\pi}\mathbb{E}\left[r(x,y)\right]-\beta\;D_{\mathrm{KL}}\left[%
\pi(y|x)\|\pi_{\text{ref}}(y|x)\right],</annotation><annotation encoding="application/x-llamapun" id="S2.E1.m1.2d">italic_J start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT = roman_max start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT blackboard_E [ italic_r ( italic_x , italic_y ) ] - italic_β italic_D start_POSTSUBSCRIPT roman_KL end_POSTSUBSCRIPT [ italic_π ( italic_y | italic_x ) ∥ italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT ( italic_y | italic_x ) ] ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS1.p2.9"><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.1">where </span><math alttext="r(x,y)" class="ltx_Math" display="inline" id="S2.SS1.p2.4.m1.2"><semantics id="S2.SS1.p2.4.m1.2a"><mrow id="S2.SS1.p2.4.m1.2.3" xref="S2.SS1.p2.4.m1.2.3.cmml"><mi id="S2.SS1.p2.4.m1.2.3.2" xref="S2.SS1.p2.4.m1.2.3.2.cmml">r</mi><mo id="S2.SS1.p2.4.m1.2.3.1" xref="S2.SS1.p2.4.m1.2.3.1.cmml">⁢</mo><mrow id="S2.SS1.p2.4.m1.2.3.3.2" xref="S2.SS1.p2.4.m1.2.3.3.1.cmml"><mo id="S2.SS1.p2.4.m1.2.3.3.2.1" stretchy="false" xref="S2.SS1.p2.4.m1.2.3.3.1.cmml">(</mo><mi id="S2.SS1.p2.4.m1.1.1" xref="S2.SS1.p2.4.m1.1.1.cmml">x</mi><mo id="S2.SS1.p2.4.m1.2.3.3.2.2" xref="S2.SS1.p2.4.m1.2.3.3.1.cmml">,</mo><mi id="S2.SS1.p2.4.m1.2.2" xref="S2.SS1.p2.4.m1.2.2.cmml">y</mi><mo id="S2.SS1.p2.4.m1.2.3.3.2.3" stretchy="false" xref="S2.SS1.p2.4.m1.2.3.3.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.4.m1.2b"><apply id="S2.SS1.p2.4.m1.2.3.cmml" xref="S2.SS1.p2.4.m1.2.3"><times id="S2.SS1.p2.4.m1.2.3.1.cmml" xref="S2.SS1.p2.4.m1.2.3.1"></times><ci id="S2.SS1.p2.4.m1.2.3.2.cmml" xref="S2.SS1.p2.4.m1.2.3.2">𝑟</ci><interval closure="open" id="S2.SS1.p2.4.m1.2.3.3.1.cmml" xref="S2.SS1.p2.4.m1.2.3.3.2"><ci id="S2.SS1.p2.4.m1.1.1.cmml" xref="S2.SS1.p2.4.m1.1.1">𝑥</ci><ci id="S2.SS1.p2.4.m1.2.2.cmml" xref="S2.SS1.p2.4.m1.2.2">𝑦</ci></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.4.m1.2c">r(x,y)</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.4.m1.2d">italic_r ( italic_x , italic_y )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.2"> corresponds to the reward for response </span><math alttext="y" class="ltx_Math" display="inline" id="S2.SS1.p2.5.m2.1"><semantics id="S2.SS1.p2.5.m2.1a"><mi id="S2.SS1.p2.5.m2.1.1" xref="S2.SS1.p2.5.m2.1.1.cmml">y</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.5.m2.1b"><ci id="S2.SS1.p2.5.m2.1.1.cmml" xref="S2.SS1.p2.5.m2.1.1">𝑦</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.5.m2.1c">y</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.5.m2.1d">italic_y</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.3"> given input </span><math alttext="x" class="ltx_Math" display="inline" id="S2.SS1.p2.6.m3.1"><semantics id="S2.SS1.p2.6.m3.1a"><mi id="S2.SS1.p2.6.m3.1.1" xref="S2.SS1.p2.6.m3.1.1.cmml">x</mi><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.6.m3.1b"><ci id="S2.SS1.p2.6.m3.1.1.cmml" xref="S2.SS1.p2.6.m3.1.1">𝑥</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.6.m3.1c">x</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.6.m3.1d">italic_x</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.4">, </span><math alttext="D_{\mathrm{KL}}" class="ltx_Math" display="inline" id="S2.SS1.p2.7.m4.1"><semantics id="S2.SS1.p2.7.m4.1a"><msub id="S2.SS1.p2.7.m4.1.1" xref="S2.SS1.p2.7.m4.1.1.cmml"><mi id="S2.SS1.p2.7.m4.1.1.2" xref="S2.SS1.p2.7.m4.1.1.2.cmml">D</mi><mi id="S2.SS1.p2.7.m4.1.1.3" xref="S2.SS1.p2.7.m4.1.1.3.cmml">KL</mi></msub><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.7.m4.1b"><apply id="S2.SS1.p2.7.m4.1.1.cmml" xref="S2.SS1.p2.7.m4.1.1"><csymbol cd="ambiguous" id="S2.SS1.p2.7.m4.1.1.1.cmml" xref="S2.SS1.p2.7.m4.1.1">subscript</csymbol><ci id="S2.SS1.p2.7.m4.1.1.2.cmml" xref="S2.SS1.p2.7.m4.1.1.2">𝐷</ci><ci id="S2.SS1.p2.7.m4.1.1.3.cmml" xref="S2.SS1.p2.7.m4.1.1.3">KL</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.7.m4.1c">D_{\mathrm{KL}}</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.7.m4.1d">italic_D start_POSTSUBSCRIPT roman_KL end_POSTSUBSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.5"> is the Kullback-Leibler Divergence between the response of the policy </span><math alttext="\pi(y|x)" class="ltx_Math" display="inline" id="S2.SS1.p2.8.m5.1"><semantics id="S2.SS1.p2.8.m5.1a"><mrow id="S2.SS1.p2.8.m5.1.1" xref="S2.SS1.p2.8.m5.1.1.cmml"><mi id="S2.SS1.p2.8.m5.1.1.3" xref="S2.SS1.p2.8.m5.1.1.3.cmml">π</mi><mo id="S2.SS1.p2.8.m5.1.1.2" xref="S2.SS1.p2.8.m5.1.1.2.cmml">⁢</mo><mrow id="S2.SS1.p2.8.m5.1.1.1.1" xref="S2.SS1.p2.8.m5.1.1.1.1.1.cmml"><mo id="S2.SS1.p2.8.m5.1.1.1.1.2" stretchy="false" xref="S2.SS1.p2.8.m5.1.1.1.1.1.cmml">(</mo><mrow id="S2.SS1.p2.8.m5.1.1.1.1.1" xref="S2.SS1.p2.8.m5.1.1.1.1.1.cmml"><mi id="S2.SS1.p2.8.m5.1.1.1.1.1.2" xref="S2.SS1.p2.8.m5.1.1.1.1.1.2.cmml">y</mi><mo fence="false" id="S2.SS1.p2.8.m5.1.1.1.1.1.1" xref="S2.SS1.p2.8.m5.1.1.1.1.1.1.cmml">|</mo><mi id="S2.SS1.p2.8.m5.1.1.1.1.1.3" xref="S2.SS1.p2.8.m5.1.1.1.1.1.3.cmml">x</mi></mrow><mo id="S2.SS1.p2.8.m5.1.1.1.1.3" stretchy="false" xref="S2.SS1.p2.8.m5.1.1.1.1.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.8.m5.1b"><apply id="S2.SS1.p2.8.m5.1.1.cmml" xref="S2.SS1.p2.8.m5.1.1"><times id="S2.SS1.p2.8.m5.1.1.2.cmml" xref="S2.SS1.p2.8.m5.1.1.2"></times><ci id="S2.SS1.p2.8.m5.1.1.3.cmml" xref="S2.SS1.p2.8.m5.1.1.3">𝜋</ci><apply id="S2.SS1.p2.8.m5.1.1.1.1.1.cmml" xref="S2.SS1.p2.8.m5.1.1.1.1"><csymbol cd="latexml" id="S2.SS1.p2.8.m5.1.1.1.1.1.1.cmml" xref="S2.SS1.p2.8.m5.1.1.1.1.1.1">conditional</csymbol><ci id="S2.SS1.p2.8.m5.1.1.1.1.1.2.cmml" xref="S2.SS1.p2.8.m5.1.1.1.1.1.2">𝑦</ci><ci id="S2.SS1.p2.8.m5.1.1.1.1.1.3.cmml" xref="S2.SS1.p2.8.m5.1.1.1.1.1.3">𝑥</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.8.m5.1c">\pi(y|x)</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.8.m5.1d">italic_π ( italic_y | italic_x )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.6"> and the reference </span><math alttext="\pi_{\text{ref}}(y|x)" class="ltx_Math" display="inline" id="S2.SS1.p2.9.m6.1"><semantics id="S2.SS1.p2.9.m6.1a"><mrow id="S2.SS1.p2.9.m6.1.1" xref="S2.SS1.p2.9.m6.1.1.cmml"><msub id="S2.SS1.p2.9.m6.1.1.3" xref="S2.SS1.p2.9.m6.1.1.3.cmml"><mi id="S2.SS1.p2.9.m6.1.1.3.2" xref="S2.SS1.p2.9.m6.1.1.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS1.p2.9.m6.1.1.3.3" xref="S2.SS1.p2.9.m6.1.1.3.3a.cmml">ref</mtext></msub><mo id="S2.SS1.p2.9.m6.1.1.2" xref="S2.SS1.p2.9.m6.1.1.2.cmml">⁢</mo><mrow id="S2.SS1.p2.9.m6.1.1.1.1" xref="S2.SS1.p2.9.m6.1.1.1.1.1.cmml"><mo id="S2.SS1.p2.9.m6.1.1.1.1.2" stretchy="false" xref="S2.SS1.p2.9.m6.1.1.1.1.1.cmml">(</mo><mrow id="S2.SS1.p2.9.m6.1.1.1.1.1" xref="S2.SS1.p2.9.m6.1.1.1.1.1.cmml"><mi id="S2.SS1.p2.9.m6.1.1.1.1.1.2" xref="S2.SS1.p2.9.m6.1.1.1.1.1.2.cmml">y</mi><mo fence="false" id="S2.SS1.p2.9.m6.1.1.1.1.1.1" xref="S2.SS1.p2.9.m6.1.1.1.1.1.1.cmml">|</mo><mi id="S2.SS1.p2.9.m6.1.1.1.1.1.3" xref="S2.SS1.p2.9.m6.1.1.1.1.1.3.cmml">x</mi></mrow><mo id="S2.SS1.p2.9.m6.1.1.1.1.3" stretchy="false" xref="S2.SS1.p2.9.m6.1.1.1.1.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS1.p2.9.m6.1b"><apply id="S2.SS1.p2.9.m6.1.1.cmml" xref="S2.SS1.p2.9.m6.1.1"><times id="S2.SS1.p2.9.m6.1.1.2.cmml" xref="S2.SS1.p2.9.m6.1.1.2"></times><apply id="S2.SS1.p2.9.m6.1.1.3.cmml" xref="S2.SS1.p2.9.m6.1.1.3"><csymbol cd="ambiguous" id="S2.SS1.p2.9.m6.1.1.3.1.cmml" xref="S2.SS1.p2.9.m6.1.1.3">subscript</csymbol><ci id="S2.SS1.p2.9.m6.1.1.3.2.cmml" xref="S2.SS1.p2.9.m6.1.1.3.2">𝜋</ci><ci id="S2.SS1.p2.9.m6.1.1.3.3a.cmml" xref="S2.SS1.p2.9.m6.1.1.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS1.p2.9.m6.1.1.3.3.cmml" mathsize="70%" xref="S2.SS1.p2.9.m6.1.1.3.3">ref</mtext></ci></apply><apply id="S2.SS1.p2.9.m6.1.1.1.1.1.cmml" xref="S2.SS1.p2.9.m6.1.1.1.1"><csymbol cd="latexml" id="S2.SS1.p2.9.m6.1.1.1.1.1.1.cmml" xref="S2.SS1.p2.9.m6.1.1.1.1.1.1">conditional</csymbol><ci id="S2.SS1.p2.9.m6.1.1.1.1.1.2.cmml" xref="S2.SS1.p2.9.m6.1.1.1.1.1.2">𝑦</ci><ci id="S2.SS1.p2.9.m6.1.1.1.1.1.3.cmml" xref="S2.SS1.p2.9.m6.1.1.1.1.1.3">𝑥</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS1.p2.9.m6.1c">\pi_{\text{ref}}(y|x)</annotation><annotation encoding="application/x-llamapun" id="S2.SS1.p2.9.m6.1d">italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT ( italic_y | italic_x )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS1.p2.9.7">.
In practice, the policy and reference models are the same at the beginning of training while the latter remains frozen.</span></p>
</div>
</section>
<section class="ltx_subsection" id="S2.SS2">
<h3 class="ltx_title ltx_font_typewriter ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection"><span class="ltx_text ltx_font_serif" id="S2.SS2.1.1.1">2.2</span> </span>Sparse Preference Optimization</h3>
<div class="ltx_para ltx_noindent" id="S2.SS2.p1">
<p class="ltx_p" id="S2.SS2.p1.5"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.5.1">Motivated by the fact that not all tokens are required to infer a preference, and in order to control token-level contributions, we start by converting the previous objective (Equation&nbsp;</span><a class="ltx_ref ltx_font_typewriter" href="https://arxiv.org/html/2410.05102v1#S2.E1" title="In 2.1 Preference Optimization ‣ 2 Methodology ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_tag">1</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.5.2">) that operates on the sequence-level to token-level. Based on the work of </span><cite class="ltx_cite ltx_citemacro_citet"><span class="ltx_text ltx_font_typewriter">Zeng et&nbsp;al.</span> <span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.5.3.1.1.1">(</span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib37" title=""><span class="ltx_text ltx_font_typewriter">2024</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.5.4.2.2.1">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.5.5"> (TDPO), this corresponds to maximizing the following equation:</span></p>
<table class="ltx_equation ltx_eqn_table" id="S2.E2">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="J_{\pi}=\max_{\pi}\mathbb{E}_{x,y^{<t}\sim D}\left[A_{\pi_{\text{ref}}}(y^{t}|%
x,y^{<t})-\beta D_{\mathrm{KL}}(\pi(y^{t}|x,y^{<t})||\pi_{\text{ref}}(y^{t}|x,%
y^{<t}))\right]" class="ltx_math_unparsed" display="block" id="S2.E2.m1.5"><semantics id="S2.E2.m1.5a"><mrow id="S2.E2.m1.5b"><msub id="S2.E2.m1.5.6"><mi id="S2.E2.m1.5.6.2">J</mi><mi id="S2.E2.m1.5.6.3">π</mi></msub><mo id="S2.E2.m1.5.7">=</mo><munder id="S2.E2.m1.5.8"><mi id="S2.E2.m1.5.8.2">max</mi><mi id="S2.E2.m1.5.8.3">π</mi></munder><msub id="S2.E2.m1.5.9"><mi id="S2.E2.m1.5.9.2">𝔼</mi><mrow id="S2.E2.m1.2.2.2"><mrow id="S2.E2.m1.2.2.2.2.1"><mi id="S2.E2.m1.1.1.1.1">x</mi><mo id="S2.E2.m1.2.2.2.2.1.2">,</mo><msup id="S2.E2.m1.2.2.2.2.1.1"><mi id="S2.E2.m1.2.2.2.2.1.1.2">y</mi><mrow id="S2.E2.m1.2.2.2.2.1.1.3"><mi id="S2.E2.m1.2.2.2.2.1.1.3.2"></mi><mo id="S2.E2.m1.2.2.2.2.1.1.3.1">&lt;</mo><mi id="S2.E2.m1.2.2.2.2.1.1.3.3">t</mi></mrow></msup></mrow><mo id="S2.E2.m1.2.2.2.3">∼</mo><mi id="S2.E2.m1.2.2.2.4">D</mi></mrow></msub><mrow id="S2.E2.m1.5.10"><mo id="S2.E2.m1.5.10.1">[</mo><msub id="S2.E2.m1.5.10.2"><mi id="S2.E2.m1.5.10.2.2">A</mi><msub id="S2.E2.m1.5.10.2.3"><mi id="S2.E2.m1.5.10.2.3.2">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E2.m1.5.10.2.3.3">ref</mtext></msub></msub><mrow id="S2.E2.m1.5.10.3"><mo id="S2.E2.m1.5.10.3.1" stretchy="false">(</mo><msup id="S2.E2.m1.5.10.3.2"><mi id="S2.E2.m1.5.10.3.2.2">y</mi><mi id="S2.E2.m1.5.10.3.2.3">t</mi></msup><mo fence="false" id="S2.E2.m1.5.10.3.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E2.m1.3.3">x</mi><mo id="S2.E2.m1.5.10.3.4">,</mo><msup id="S2.E2.m1.5.10.3.5"><mi id="S2.E2.m1.5.10.3.5.2">y</mi><mrow id="S2.E2.m1.5.10.3.5.3"><mi id="S2.E2.m1.5.10.3.5.3.2"></mi><mo id="S2.E2.m1.5.10.3.5.3.1">&lt;</mo><mi id="S2.E2.m1.5.10.3.5.3.3">t</mi></mrow></msup><mo id="S2.E2.m1.5.10.3.6" stretchy="false">)</mo></mrow><mo id="S2.E2.m1.5.10.4">−</mo><mi id="S2.E2.m1.5.10.5">β</mi><msub id="S2.E2.m1.5.10.6"><mi id="S2.E2.m1.5.10.6.2">D</mi><mi id="S2.E2.m1.5.10.6.3">KL</mi></msub><mrow id="S2.E2.m1.5.10.7"><mo id="S2.E2.m1.5.10.7.1" stretchy="false">(</mo><mi id="S2.E2.m1.5.10.7.2">π</mi><mrow id="S2.E2.m1.5.10.7.3"><mo id="S2.E2.m1.5.10.7.3.1" stretchy="false">(</mo><msup id="S2.E2.m1.5.10.7.3.2"><mi id="S2.E2.m1.5.10.7.3.2.2">y</mi><mi id="S2.E2.m1.5.10.7.3.2.3">t</mi></msup><mo fence="false" id="S2.E2.m1.5.10.7.3.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E2.m1.4.4">x</mi><mo id="S2.E2.m1.5.10.7.3.4">,</mo><msup id="S2.E2.m1.5.10.7.3.5"><mi id="S2.E2.m1.5.10.7.3.5.2">y</mi><mrow id="S2.E2.m1.5.10.7.3.5.3"><mi id="S2.E2.m1.5.10.7.3.5.3.2"></mi><mo id="S2.E2.m1.5.10.7.3.5.3.1">&lt;</mo><mi id="S2.E2.m1.5.10.7.3.5.3.3">t</mi></mrow></msup><mo id="S2.E2.m1.5.10.7.3.6" stretchy="false">)</mo></mrow><mo fence="false" id="S2.E2.m1.5.10.7.4" rspace="0.167em" stretchy="false">|</mo><mo fence="false" id="S2.E2.m1.5.10.7.5" rspace="0.167em" stretchy="false">|</mo><msub id="S2.E2.m1.5.10.7.6"><mi id="S2.E2.m1.5.10.7.6.2">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E2.m1.5.10.7.6.3">ref</mtext></msub><mrow id="S2.E2.m1.5.10.7.7"><mo id="S2.E2.m1.5.10.7.7.1" stretchy="false">(</mo><msup id="S2.E2.m1.5.10.7.7.2"><mi id="S2.E2.m1.5.10.7.7.2.2">y</mi><mi id="S2.E2.m1.5.10.7.7.2.3">t</mi></msup><mo fence="false" id="S2.E2.m1.5.10.7.7.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E2.m1.5.5">x</mi><mo id="S2.E2.m1.5.10.7.7.4">,</mo><msup id="S2.E2.m1.5.10.7.7.5"><mi id="S2.E2.m1.5.10.7.7.5.2">y</mi><mrow id="S2.E2.m1.5.10.7.7.5.3"><mi id="S2.E2.m1.5.10.7.7.5.3.2"></mi><mo id="S2.E2.m1.5.10.7.7.5.3.1">&lt;</mo><mi id="S2.E2.m1.5.10.7.7.5.3.3">t</mi></mrow></msup><mo id="S2.E2.m1.5.10.7.7.6" stretchy="false">)</mo></mrow><mo id="S2.E2.m1.5.10.7.8" stretchy="false">)</mo></mrow><mo id="S2.E2.m1.5.10.8">]</mo></mrow></mrow><annotation encoding="application/x-tex" id="S2.E2.m1.5c">J_{\pi}=\max_{\pi}\mathbb{E}_{x,y^{&lt;t}\sim D}\left[A_{\pi_{\text{ref}}}(y^{t}|%
x,y^{&lt;t})-\beta D_{\mathrm{KL}}(\pi(y^{t}|x,y^{&lt;t})||\pi_{\text{ref}}(y^{t}|x,%
y^{&lt;t}))\right]</annotation><annotation encoding="application/x-llamapun" id="S2.E2.m1.5d">italic_J start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT = roman_max start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT blackboard_E start_POSTSUBSCRIPT italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ∼ italic_D end_POSTSUBSCRIPT [ italic_A start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) - italic_β italic_D start_POSTSUBSCRIPT roman_KL end_POSTSUBSCRIPT ( italic_π ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) | | italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) ) ]</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS2.p1.4"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.4.1">with </span><math alttext="A_{\pi_{\text{ref}}}(y^{t}|x,y^{<t})\equiv Q_{\pi_{\text{ref}}}(y^{t}|x,y^{<t}%
)-V_{\pi_{\text{ref}}}(x,y^{<t})" class="ltx_Math" display="inline" id="S2.SS2.p1.1.m1.6"><semantics id="S2.SS2.p1.1.m1.6a"><mrow id="S2.SS2.p1.1.m1.6.6" xref="S2.SS2.p1.1.m1.6.6.cmml"><mrow id="S2.SS2.p1.1.m1.4.4.1" xref="S2.SS2.p1.1.m1.4.4.1.cmml"><msub id="S2.SS2.p1.1.m1.4.4.1.3" xref="S2.SS2.p1.1.m1.4.4.1.3.cmml"><mi id="S2.SS2.p1.1.m1.4.4.1.3.2" xref="S2.SS2.p1.1.m1.4.4.1.3.2.cmml">A</mi><msub id="S2.SS2.p1.1.m1.4.4.1.3.3" xref="S2.SS2.p1.1.m1.4.4.1.3.3.cmml"><mi id="S2.SS2.p1.1.m1.4.4.1.3.3.2" xref="S2.SS2.p1.1.m1.4.4.1.3.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.4.4.1.3.3.3" xref="S2.SS2.p1.1.m1.4.4.1.3.3.3a.cmml">ref</mtext></msub></msub><mo id="S2.SS2.p1.1.m1.4.4.1.2" xref="S2.SS2.p1.1.m1.4.4.1.2.cmml">⁢</mo><mrow id="S2.SS2.p1.1.m1.4.4.1.1.1" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.cmml"><mo id="S2.SS2.p1.1.m1.4.4.1.1.1.2" stretchy="false" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.cmml">(</mo><mrow id="S2.SS2.p1.1.m1.4.4.1.1.1.1" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.cmml"><msup id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.cmml"><mi id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.2" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.2.cmml">y</mi><mi id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.3" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.3.cmml">t</mi></msup><mo fence="false" id="S2.SS2.p1.1.m1.4.4.1.1.1.1.2" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.2.cmml">|</mo><mrow id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.2.cmml"><mi id="S2.SS2.p1.1.m1.1.1" xref="S2.SS2.p1.1.m1.1.1.cmml">x</mi><mo id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.2" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.2.cmml">,</mo><msup id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.cmml"><mi id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.2" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.cmml"><mi id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.2" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.1" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.3" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup></mrow></mrow><mo id="S2.SS2.p1.1.m1.4.4.1.1.1.3" stretchy="false" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.SS2.p1.1.m1.6.6.4" xref="S2.SS2.p1.1.m1.6.6.4.cmml">≡</mo><mrow id="S2.SS2.p1.1.m1.6.6.3" xref="S2.SS2.p1.1.m1.6.6.3.cmml"><mrow id="S2.SS2.p1.1.m1.5.5.2.1" xref="S2.SS2.p1.1.m1.5.5.2.1.cmml"><msub id="S2.SS2.p1.1.m1.5.5.2.1.3" xref="S2.SS2.p1.1.m1.5.5.2.1.3.cmml"><mi id="S2.SS2.p1.1.m1.5.5.2.1.3.2" xref="S2.SS2.p1.1.m1.5.5.2.1.3.2.cmml">Q</mi><msub id="S2.SS2.p1.1.m1.5.5.2.1.3.3" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.cmml"><mi id="S2.SS2.p1.1.m1.5.5.2.1.3.3.2" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.5.5.2.1.3.3.3" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.3a.cmml">ref</mtext></msub></msub><mo id="S2.SS2.p1.1.m1.5.5.2.1.2" xref="S2.SS2.p1.1.m1.5.5.2.1.2.cmml">⁢</mo><mrow id="S2.SS2.p1.1.m1.5.5.2.1.1.1" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.cmml"><mo id="S2.SS2.p1.1.m1.5.5.2.1.1.1.2" stretchy="false" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.cmml">(</mo><mrow id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.cmml"><msup id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.cmml"><mi id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.2" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.2.cmml">y</mi><mi id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.3" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.3.cmml">t</mi></msup><mo fence="false" id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.2" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.2.cmml">|</mo><mrow id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.2.cmml"><mi id="S2.SS2.p1.1.m1.2.2" xref="S2.SS2.p1.1.m1.2.2.cmml">x</mi><mo id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.2" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.2.cmml">,</mo><msup id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.cmml"><mi id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.2" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.cmml"><mi id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.2" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.1" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.3" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup></mrow></mrow><mo id="S2.SS2.p1.1.m1.5.5.2.1.1.1.3" stretchy="false" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.SS2.p1.1.m1.6.6.3.3" xref="S2.SS2.p1.1.m1.6.6.3.3.cmml">−</mo><mrow id="S2.SS2.p1.1.m1.6.6.3.2" xref="S2.SS2.p1.1.m1.6.6.3.2.cmml"><msub id="S2.SS2.p1.1.m1.6.6.3.2.3" xref="S2.SS2.p1.1.m1.6.6.3.2.3.cmml"><mi id="S2.SS2.p1.1.m1.6.6.3.2.3.2" xref="S2.SS2.p1.1.m1.6.6.3.2.3.2.cmml">V</mi><msub id="S2.SS2.p1.1.m1.6.6.3.2.3.3" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.cmml"><mi id="S2.SS2.p1.1.m1.6.6.3.2.3.3.2" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.6.6.3.2.3.3.3" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.3a.cmml">ref</mtext></msub></msub><mo id="S2.SS2.p1.1.m1.6.6.3.2.2" xref="S2.SS2.p1.1.m1.6.6.3.2.2.cmml">⁢</mo><mrow id="S2.SS2.p1.1.m1.6.6.3.2.1.1" xref="S2.SS2.p1.1.m1.6.6.3.2.1.2.cmml"><mo id="S2.SS2.p1.1.m1.6.6.3.2.1.1.2" stretchy="false" xref="S2.SS2.p1.1.m1.6.6.3.2.1.2.cmml">(</mo><mi id="S2.SS2.p1.1.m1.3.3" xref="S2.SS2.p1.1.m1.3.3.cmml">x</mi><mo id="S2.SS2.p1.1.m1.6.6.3.2.1.1.3" xref="S2.SS2.p1.1.m1.6.6.3.2.1.2.cmml">,</mo><msup id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.cmml"><mi id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.2" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.cmml"><mi id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.2" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.1" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.3" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p1.1.m1.6.6.3.2.1.1.4" stretchy="false" xref="S2.SS2.p1.1.m1.6.6.3.2.1.2.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS2.p1.1.m1.6b"><apply id="S2.SS2.p1.1.m1.6.6.cmml" xref="S2.SS2.p1.1.m1.6.6"><equivalent id="S2.SS2.p1.1.m1.6.6.4.cmml" xref="S2.SS2.p1.1.m1.6.6.4"></equivalent><apply id="S2.SS2.p1.1.m1.4.4.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1"><times id="S2.SS2.p1.1.m1.4.4.1.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.2"></times><apply id="S2.SS2.p1.1.m1.4.4.1.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.4.4.1.3.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.4.4.1.3.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3.2">𝐴</ci><apply id="S2.SS2.p1.1.m1.4.4.1.3.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.4.4.1.3.3.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.4.4.1.3.3.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3.3.2">𝜋</ci><ci id="S2.SS2.p1.1.m1.4.4.1.3.3.3a.cmml" xref="S2.SS2.p1.1.m1.4.4.1.3.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.4.4.1.3.3.3.cmml" mathsize="50%" xref="S2.SS2.p1.1.m1.4.4.1.3.3.3">ref</mtext></ci></apply></apply><apply id="S2.SS2.p1.1.m1.4.4.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1"><csymbol cd="latexml" id="S2.SS2.p1.1.m1.4.4.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.2">conditional</csymbol><apply id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3">superscript</csymbol><ci id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.2">𝑦</ci><ci id="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.3.3">𝑡</ci></apply><list id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1"><ci id="S2.SS2.p1.1.m1.1.1.cmml" xref="S2.SS2.p1.1.m1.1.1">𝑥</ci><apply id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1">superscript</csymbol><ci id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3"><lt id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.1.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.2.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.3.cmml" xref="S2.SS2.p1.1.m1.4.4.1.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></list></apply></apply><apply id="S2.SS2.p1.1.m1.6.6.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3"><minus id="S2.SS2.p1.1.m1.6.6.3.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3.3"></minus><apply id="S2.SS2.p1.1.m1.5.5.2.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1"><times id="S2.SS2.p1.1.m1.5.5.2.1.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.2"></times><apply id="S2.SS2.p1.1.m1.5.5.2.1.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.5.5.2.1.3.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.5.5.2.1.3.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3.2">𝑄</ci><apply id="S2.SS2.p1.1.m1.5.5.2.1.3.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.5.5.2.1.3.3.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.5.5.2.1.3.3.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.2">𝜋</ci><ci id="S2.SS2.p1.1.m1.5.5.2.1.3.3.3a.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.5.5.2.1.3.3.3.cmml" mathsize="50%" xref="S2.SS2.p1.1.m1.5.5.2.1.3.3.3">ref</mtext></ci></apply></apply><apply id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1"><csymbol cd="latexml" id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.2">conditional</csymbol><apply id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3">superscript</csymbol><ci id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.2">𝑦</ci><ci id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.3.3">𝑡</ci></apply><list id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1"><ci id="S2.SS2.p1.1.m1.2.2.cmml" xref="S2.SS2.p1.1.m1.2.2">𝑥</ci><apply id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1">superscript</csymbol><ci id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3"><lt id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.1.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.2.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.3.cmml" xref="S2.SS2.p1.1.m1.5.5.2.1.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></list></apply></apply><apply id="S2.SS2.p1.1.m1.6.6.3.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2"><times id="S2.SS2.p1.1.m1.6.6.3.2.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.2"></times><apply id="S2.SS2.p1.1.m1.6.6.3.2.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.6.6.3.2.3.1.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.6.6.3.2.3.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3.2">𝑉</ci><apply id="S2.SS2.p1.1.m1.6.6.3.2.3.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.6.6.3.2.3.3.1.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3">subscript</csymbol><ci id="S2.SS2.p1.1.m1.6.6.3.2.3.3.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.2">𝜋</ci><ci id="S2.SS2.p1.1.m1.6.6.3.2.3.3.3a.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p1.1.m1.6.6.3.2.3.3.3.cmml" mathsize="50%" xref="S2.SS2.p1.1.m1.6.6.3.2.3.3.3">ref</mtext></ci></apply></apply><interval closure="open" id="S2.SS2.p1.1.m1.6.6.3.2.1.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1"><ci id="S2.SS2.p1.1.m1.3.3.cmml" xref="S2.SS2.p1.1.m1.3.3">𝑥</ci><apply id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.1.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1">superscript</csymbol><ci id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.2">𝑦</ci><apply id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3"><lt id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.1.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.2.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.3.cmml" xref="S2.SS2.p1.1.m1.6.6.3.2.1.1.1.3.3">𝑡</ci></apply></apply></interval></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p1.1.m1.6c">A_{\pi_{\text{ref}}}(y^{t}|x,y^{&lt;t})\equiv Q_{\pi_{\text{ref}}}(y^{t}|x,y^{&lt;t}%
)-V_{\pi_{\text{ref}}}(x,y^{&lt;t})</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p1.1.m1.6d">italic_A start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) ≡ italic_Q start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) - italic_V start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.4.2"> being the advantage function for the reference model as the difference between the state-action </span><math alttext="Q" class="ltx_Math" display="inline" id="S2.SS2.p1.2.m2.1"><semantics id="S2.SS2.p1.2.m2.1a"><mi id="S2.SS2.p1.2.m2.1.1" xref="S2.SS2.p1.2.m2.1.1.cmml">Q</mi><annotation-xml encoding="MathML-Content" id="S2.SS2.p1.2.m2.1b"><ci id="S2.SS2.p1.2.m2.1.1.cmml" xref="S2.SS2.p1.2.m2.1.1">𝑄</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p1.2.m2.1c">Q</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p1.2.m2.1d">italic_Q</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.4.3"> and the state-value function </span><math alttext="V" class="ltx_Math" display="inline" id="S2.SS2.p1.3.m3.1"><semantics id="S2.SS2.p1.3.m3.1a"><mi id="S2.SS2.p1.3.m3.1.1" xref="S2.SS2.p1.3.m3.1.1.cmml">V</mi><annotation-xml encoding="MathML-Content" id="S2.SS2.p1.3.m3.1b"><ci id="S2.SS2.p1.3.m3.1.1.cmml" xref="S2.SS2.p1.3.m3.1.1">𝑉</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p1.3.m3.1c">V</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p1.3.m3.1d">italic_V</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.4.4">, and </span><math alttext="\beta" class="ltx_Math" display="inline" id="S2.SS2.p1.4.m4.1"><semantics id="S2.SS2.p1.4.m4.1a"><mi id="S2.SS2.p1.4.m4.1.1" xref="S2.SS2.p1.4.m4.1.1.cmml">β</mi><annotation-xml encoding="MathML-Content" id="S2.SS2.p1.4.m4.1b"><ci id="S2.SS2.p1.4.m4.1.1.cmml" xref="S2.SS2.p1.4.m4.1.1">𝛽</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p1.4.m4.1c">\beta</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p1.4.m4.1d">italic_β</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p1.4.5"> being a tunable parameter controlling the deviation from the reference model.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S2.SS2.p2">
<p class="ltx_p" id="S2.SS2.p2.1"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p2.1.1">We argue that in order to control the contribution of each token, we can add a weight in front of the token-level KL divergence term, so that not all tokens are forced to stay close to the reference model. We speculate that this will lead to more diverse generation of responses, since only a handful of important tokens that indicate preference will have to be in-distribution.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S2.SS2.p3">
<p class="ltx_p" id="S2.SS2.p3.4"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.4.1">Thus, we introduce a mask function </span><math alttext="m(y^{<t})\in[0,1]" class="ltx_Math" display="inline" id="S2.SS2.p3.1.m1.3"><semantics id="S2.SS2.p3.1.m1.3a"><mrow id="S2.SS2.p3.1.m1.3.3" xref="S2.SS2.p3.1.m1.3.3.cmml"><mrow id="S2.SS2.p3.1.m1.3.3.1" xref="S2.SS2.p3.1.m1.3.3.1.cmml"><mi id="S2.SS2.p3.1.m1.3.3.1.3" xref="S2.SS2.p3.1.m1.3.3.1.3.cmml">m</mi><mo id="S2.SS2.p3.1.m1.3.3.1.2" xref="S2.SS2.p3.1.m1.3.3.1.2.cmml">⁢</mo><mrow id="S2.SS2.p3.1.m1.3.3.1.1.1" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.cmml"><mo id="S2.SS2.p3.1.m1.3.3.1.1.1.2" stretchy="false" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.cmml">(</mo><msup id="S2.SS2.p3.1.m1.3.3.1.1.1.1" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.cmml"><mi id="S2.SS2.p3.1.m1.3.3.1.1.1.1.2" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.cmml"><mi id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.2" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.1" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.3" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p3.1.m1.3.3.1.1.1.3" stretchy="false" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.SS2.p3.1.m1.3.3.2" xref="S2.SS2.p3.1.m1.3.3.2.cmml">∈</mo><mrow id="S2.SS2.p3.1.m1.3.3.3.2" xref="S2.SS2.p3.1.m1.3.3.3.1.cmml"><mo id="S2.SS2.p3.1.m1.3.3.3.2.1" stretchy="false" xref="S2.SS2.p3.1.m1.3.3.3.1.cmml">[</mo><mn id="S2.SS2.p3.1.m1.1.1" xref="S2.SS2.p3.1.m1.1.1.cmml">0</mn><mo id="S2.SS2.p3.1.m1.3.3.3.2.2" xref="S2.SS2.p3.1.m1.3.3.3.1.cmml">,</mo><mn id="S2.SS2.p3.1.m1.2.2" xref="S2.SS2.p3.1.m1.2.2.cmml">1</mn><mo id="S2.SS2.p3.1.m1.3.3.3.2.3" stretchy="false" xref="S2.SS2.p3.1.m1.3.3.3.1.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.1.m1.3b"><apply id="S2.SS2.p3.1.m1.3.3.cmml" xref="S2.SS2.p3.1.m1.3.3"><in id="S2.SS2.p3.1.m1.3.3.2.cmml" xref="S2.SS2.p3.1.m1.3.3.2"></in><apply id="S2.SS2.p3.1.m1.3.3.1.cmml" xref="S2.SS2.p3.1.m1.3.3.1"><times id="S2.SS2.p3.1.m1.3.3.1.2.cmml" xref="S2.SS2.p3.1.m1.3.3.1.2"></times><ci id="S2.SS2.p3.1.m1.3.3.1.3.cmml" xref="S2.SS2.p3.1.m1.3.3.1.3">𝑚</ci><apply id="S2.SS2.p3.1.m1.3.3.1.1.1.1.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.1.m1.3.3.1.1.1.1.1.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1">superscript</csymbol><ci id="S2.SS2.p3.1.m1.3.3.1.1.1.1.2.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.2">𝑦</ci><apply id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3"><lt id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.1.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.2.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.3.cmml" xref="S2.SS2.p3.1.m1.3.3.1.1.1.1.3.3">𝑡</ci></apply></apply></apply><interval closure="closed" id="S2.SS2.p3.1.m1.3.3.3.1.cmml" xref="S2.SS2.p3.1.m1.3.3.3.2"><cn id="S2.SS2.p3.1.m1.1.1.cmml" type="integer" xref="S2.SS2.p3.1.m1.1.1">0</cn><cn id="S2.SS2.p3.1.m1.2.2.cmml" type="integer" xref="S2.SS2.p3.1.m1.2.2">1</cn></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.1.m1.3c">m(y^{&lt;t})\in[0,1]</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.1.m1.3d">italic_m ( italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) ∈ [ 0 , 1 ]</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.4.2">, </span><math alttext="m(y^{<t})>\epsilon" class="ltx_Math" display="inline" id="S2.SS2.p3.2.m2.1"><semantics id="S2.SS2.p3.2.m2.1a"><mrow id="S2.SS2.p3.2.m2.1.1" xref="S2.SS2.p3.2.m2.1.1.cmml"><mrow id="S2.SS2.p3.2.m2.1.1.1" xref="S2.SS2.p3.2.m2.1.1.1.cmml"><mi id="S2.SS2.p3.2.m2.1.1.1.3" xref="S2.SS2.p3.2.m2.1.1.1.3.cmml">m</mi><mo id="S2.SS2.p3.2.m2.1.1.1.2" xref="S2.SS2.p3.2.m2.1.1.1.2.cmml">⁢</mo><mrow id="S2.SS2.p3.2.m2.1.1.1.1.1" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.cmml"><mo id="S2.SS2.p3.2.m2.1.1.1.1.1.2" stretchy="false" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.cmml">(</mo><msup id="S2.SS2.p3.2.m2.1.1.1.1.1.1" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.cmml"><mi id="S2.SS2.p3.2.m2.1.1.1.1.1.1.2" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.cmml"><mi id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.2" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.1" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.3" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p3.2.m2.1.1.1.1.1.3" stretchy="false" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.SS2.p3.2.m2.1.1.2" xref="S2.SS2.p3.2.m2.1.1.2.cmml">&gt;</mo><mi id="S2.SS2.p3.2.m2.1.1.3" xref="S2.SS2.p3.2.m2.1.1.3.cmml">ϵ</mi></mrow><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.2.m2.1b"><apply id="S2.SS2.p3.2.m2.1.1.cmml" xref="S2.SS2.p3.2.m2.1.1"><gt id="S2.SS2.p3.2.m2.1.1.2.cmml" xref="S2.SS2.p3.2.m2.1.1.2"></gt><apply id="S2.SS2.p3.2.m2.1.1.1.cmml" xref="S2.SS2.p3.2.m2.1.1.1"><times id="S2.SS2.p3.2.m2.1.1.1.2.cmml" xref="S2.SS2.p3.2.m2.1.1.1.2"></times><ci id="S2.SS2.p3.2.m2.1.1.1.3.cmml" xref="S2.SS2.p3.2.m2.1.1.1.3">𝑚</ci><apply id="S2.SS2.p3.2.m2.1.1.1.1.1.1.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.2.m2.1.1.1.1.1.1.1.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1">superscript</csymbol><ci id="S2.SS2.p3.2.m2.1.1.1.1.1.1.2.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3"><lt id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.1.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.2.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.3.cmml" xref="S2.SS2.p3.2.m2.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></apply><ci id="S2.SS2.p3.2.m2.1.1.3.cmml" xref="S2.SS2.p3.2.m2.1.1.3">italic-ϵ</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.2.m2.1c">m(y^{&lt;t})&gt;\epsilon</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.2.m2.1d">italic_m ( italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) &gt; italic_ϵ</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.4.3"> that produces a scalar for each token </span><math alttext="y^{t}" class="ltx_Math" display="inline" id="S2.SS2.p3.3.m3.1"><semantics id="S2.SS2.p3.3.m3.1a"><msup id="S2.SS2.p3.3.m3.1.1" xref="S2.SS2.p3.3.m3.1.1.cmml"><mi id="S2.SS2.p3.3.m3.1.1.2" xref="S2.SS2.p3.3.m3.1.1.2.cmml">y</mi><mi id="S2.SS2.p3.3.m3.1.1.3" xref="S2.SS2.p3.3.m3.1.1.3.cmml">t</mi></msup><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.3.m3.1b"><apply id="S2.SS2.p3.3.m3.1.1.cmml" xref="S2.SS2.p3.3.m3.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.3.m3.1.1.1.cmml" xref="S2.SS2.p3.3.m3.1.1">superscript</csymbol><ci id="S2.SS2.p3.3.m3.1.1.2.cmml" xref="S2.SS2.p3.3.m3.1.1.2">𝑦</ci><ci id="S2.SS2.p3.3.m3.1.1.3.cmml" xref="S2.SS2.p3.3.m3.1.1.3">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.3.m3.1c">y^{t}</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.3.m3.1d">italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.4.4"> in a sequence </span><math alttext="y" class="ltx_Math" display="inline" id="S2.SS2.p3.4.m4.1"><semantics id="S2.SS2.p3.4.m4.1a"><mi id="S2.SS2.p3.4.m4.1.1" xref="S2.SS2.p3.4.m4.1.1.cmml">y</mi><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.4.m4.1b"><ci id="S2.SS2.p3.4.m4.1.1.cmml" xref="S2.SS2.p3.4.m4.1.1">𝑦</ci></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.4.m4.1c">y</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.4.m4.1d">italic_y</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.4.5"> that measures the amount of token KL participation in the loss function.</span></p>
<table class="ltx_equation ltx_eqn_table" id="S2.E3">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="J_{\pi}=\max_{\pi}\mathbb{E}_{x,y^{<t}\sim D,y^{t}\sim\pi}\left[A_{\pi_{\text{%
ref}}}(y^{t}|x,y^{<t})-\beta\;m(y^{<t})\;D_{\mathrm{KL}}(\pi(y^{t}|x,y^{<t})||%
\pi_{\text{ref}}(y^{t}|x,y^{<t}))\right]" class="ltx_math_unparsed" display="block" id="S2.E3.m1.6"><semantics id="S2.E3.m1.6a"><mrow id="S2.E3.m1.6b"><msub id="S2.E3.m1.6.7"><mi id="S2.E3.m1.6.7.2">J</mi><mi id="S2.E3.m1.6.7.3">π</mi></msub><mo id="S2.E3.m1.6.8">=</mo><munder id="S2.E3.m1.6.9"><mi id="S2.E3.m1.6.9.2">max</mi><mi id="S2.E3.m1.6.9.3">π</mi></munder><msub id="S2.E3.m1.6.10"><mi id="S2.E3.m1.6.10.2">𝔼</mi><mrow id="S2.E3.m1.3.3.3.3"><mrow id="S2.E3.m1.2.2.2.2.1"><mrow id="S2.E3.m1.2.2.2.2.1.1.1"><mi id="S2.E3.m1.1.1.1.1">x</mi><mo id="S2.E3.m1.2.2.2.2.1.1.1.2">,</mo><msup id="S2.E3.m1.2.2.2.2.1.1.1.1"><mi id="S2.E3.m1.2.2.2.2.1.1.1.1.2">y</mi><mrow id="S2.E3.m1.2.2.2.2.1.1.1.1.3"><mi id="S2.E3.m1.2.2.2.2.1.1.1.1.3.2"></mi><mo id="S2.E3.m1.2.2.2.2.1.1.1.1.3.1">&lt;</mo><mi id="S2.E3.m1.2.2.2.2.1.1.1.1.3.3">t</mi></mrow></msup></mrow><mo id="S2.E3.m1.2.2.2.2.1.2">∼</mo><mi id="S2.E3.m1.2.2.2.2.1.3">D</mi></mrow><mo id="S2.E3.m1.3.3.3.3.3">,</mo><mrow id="S2.E3.m1.3.3.3.3.2"><msup id="S2.E3.m1.3.3.3.3.2.2"><mi id="S2.E3.m1.3.3.3.3.2.2.2">y</mi><mi id="S2.E3.m1.3.3.3.3.2.2.3">t</mi></msup><mo id="S2.E3.m1.3.3.3.3.2.1">∼</mo><mi id="S2.E3.m1.3.3.3.3.2.3">π</mi></mrow></mrow></msub><mrow id="S2.E3.m1.6.11"><mo id="S2.E3.m1.6.11.1">[</mo><msub id="S2.E3.m1.6.11.2"><mi id="S2.E3.m1.6.11.2.2">A</mi><msub id="S2.E3.m1.6.11.2.3"><mi id="S2.E3.m1.6.11.2.3.2">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E3.m1.6.11.2.3.3">ref</mtext></msub></msub><mrow id="S2.E3.m1.6.11.3"><mo id="S2.E3.m1.6.11.3.1" stretchy="false">(</mo><msup id="S2.E3.m1.6.11.3.2"><mi id="S2.E3.m1.6.11.3.2.2">y</mi><mi id="S2.E3.m1.6.11.3.2.3">t</mi></msup><mo fence="false" id="S2.E3.m1.6.11.3.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E3.m1.4.4">x</mi><mo id="S2.E3.m1.6.11.3.4">,</mo><msup id="S2.E3.m1.6.11.3.5"><mi id="S2.E3.m1.6.11.3.5.2">y</mi><mrow id="S2.E3.m1.6.11.3.5.3"><mi id="S2.E3.m1.6.11.3.5.3.2"></mi><mo id="S2.E3.m1.6.11.3.5.3.1">&lt;</mo><mi id="S2.E3.m1.6.11.3.5.3.3">t</mi></mrow></msup><mo id="S2.E3.m1.6.11.3.6" stretchy="false">)</mo></mrow><mo id="S2.E3.m1.6.11.4">−</mo><mi id="S2.E3.m1.6.11.5">β</mi><mi id="S2.E3.m1.6.11.6">m</mi><mrow id="S2.E3.m1.6.11.7"><mo id="S2.E3.m1.6.11.7.1" stretchy="false">(</mo><msup id="S2.E3.m1.6.11.7.2"><mi id="S2.E3.m1.6.11.7.2.2">y</mi><mrow id="S2.E3.m1.6.11.7.2.3"><mi id="S2.E3.m1.6.11.7.2.3.2"></mi><mo id="S2.E3.m1.6.11.7.2.3.1">&lt;</mo><mi id="S2.E3.m1.6.11.7.2.3.3">t</mi></mrow></msup><mo id="S2.E3.m1.6.11.7.3" rspace="0.280em" stretchy="false">)</mo></mrow><msub id="S2.E3.m1.6.11.8"><mi id="S2.E3.m1.6.11.8.2">D</mi><mi id="S2.E3.m1.6.11.8.3">KL</mi></msub><mrow id="S2.E3.m1.6.11.9"><mo id="S2.E3.m1.6.11.9.1" stretchy="false">(</mo><mi id="S2.E3.m1.6.11.9.2">π</mi><mrow id="S2.E3.m1.6.11.9.3"><mo id="S2.E3.m1.6.11.9.3.1" stretchy="false">(</mo><msup id="S2.E3.m1.6.11.9.3.2"><mi id="S2.E3.m1.6.11.9.3.2.2">y</mi><mi id="S2.E3.m1.6.11.9.3.2.3">t</mi></msup><mo fence="false" id="S2.E3.m1.6.11.9.3.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E3.m1.5.5">x</mi><mo id="S2.E3.m1.6.11.9.3.4">,</mo><msup id="S2.E3.m1.6.11.9.3.5"><mi id="S2.E3.m1.6.11.9.3.5.2">y</mi><mrow id="S2.E3.m1.6.11.9.3.5.3"><mi id="S2.E3.m1.6.11.9.3.5.3.2"></mi><mo id="S2.E3.m1.6.11.9.3.5.3.1">&lt;</mo><mi id="S2.E3.m1.6.11.9.3.5.3.3">t</mi></mrow></msup><mo id="S2.E3.m1.6.11.9.3.6" stretchy="false">)</mo></mrow><mo fence="false" id="S2.E3.m1.6.11.9.4" rspace="0.167em" stretchy="false">|</mo><mo fence="false" id="S2.E3.m1.6.11.9.5" rspace="0.167em" stretchy="false">|</mo><msub id="S2.E3.m1.6.11.9.6"><mi id="S2.E3.m1.6.11.9.6.2">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E3.m1.6.11.9.6.3">ref</mtext></msub><mrow id="S2.E3.m1.6.11.9.7"><mo id="S2.E3.m1.6.11.9.7.1" stretchy="false">(</mo><msup id="S2.E3.m1.6.11.9.7.2"><mi id="S2.E3.m1.6.11.9.7.2.2">y</mi><mi id="S2.E3.m1.6.11.9.7.2.3">t</mi></msup><mo fence="false" id="S2.E3.m1.6.11.9.7.3" rspace="0.167em" stretchy="false">|</mo><mi id="S2.E3.m1.6.6">x</mi><mo id="S2.E3.m1.6.11.9.7.4">,</mo><msup id="S2.E3.m1.6.11.9.7.5"><mi id="S2.E3.m1.6.11.9.7.5.2">y</mi><mrow id="S2.E3.m1.6.11.9.7.5.3"><mi id="S2.E3.m1.6.11.9.7.5.3.2"></mi><mo id="S2.E3.m1.6.11.9.7.5.3.1">&lt;</mo><mi id="S2.E3.m1.6.11.9.7.5.3.3">t</mi></mrow></msup><mo id="S2.E3.m1.6.11.9.7.6" stretchy="false">)</mo></mrow><mo id="S2.E3.m1.6.11.9.8" stretchy="false">)</mo></mrow><mo id="S2.E3.m1.6.11.10">]</mo></mrow></mrow><annotation encoding="application/x-tex" id="S2.E3.m1.6c">J_{\pi}=\max_{\pi}\mathbb{E}_{x,y^{&lt;t}\sim D,y^{t}\sim\pi}\left[A_{\pi_{\text{%
ref}}}(y^{t}|x,y^{&lt;t})-\beta\;m(y^{&lt;t})\;D_{\mathrm{KL}}(\pi(y^{t}|x,y^{&lt;t})||%
\pi_{\text{ref}}(y^{t}|x,y^{&lt;t}))\right]</annotation><annotation encoding="application/x-llamapun" id="S2.E3.m1.6d">italic_J start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT = roman_max start_POSTSUBSCRIPT italic_π end_POSTSUBSCRIPT blackboard_E start_POSTSUBSCRIPT italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ∼ italic_D , italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT ∼ italic_π end_POSTSUBSCRIPT [ italic_A start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) - italic_β italic_m ( italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) italic_D start_POSTSUBSCRIPT roman_KL end_POSTSUBSCRIPT ( italic_π ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) | | italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) ) ]</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(3)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS2.p3.5"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.5.1">Deriving Equation&nbsp;</span><a class="ltx_ref ltx_font_typewriter" href="https://arxiv.org/html/2410.05102v1#S2.E3" title="In 2.2 Sparse Preference Optimization ‣ 2 Methodology ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_tag">3</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.5.2">, in a similar manner as TDPO, and assuming that the mask is dependent on the reference model alone and on previously seen tokens, </span><math alttext="m(y^{<t})=f_{\pi_{\text{ref}}}(x,y^{<t})" class="ltx_Math" display="inline" id="S2.SS2.p3.5.m1.3"><semantics id="S2.SS2.p3.5.m1.3a"><mrow id="S2.SS2.p3.5.m1.3.3" xref="S2.SS2.p3.5.m1.3.3.cmml"><mrow id="S2.SS2.p3.5.m1.2.2.1" xref="S2.SS2.p3.5.m1.2.2.1.cmml"><mi id="S2.SS2.p3.5.m1.2.2.1.3" xref="S2.SS2.p3.5.m1.2.2.1.3.cmml">m</mi><mo id="S2.SS2.p3.5.m1.2.2.1.2" xref="S2.SS2.p3.5.m1.2.2.1.2.cmml">⁢</mo><mrow id="S2.SS2.p3.5.m1.2.2.1.1.1" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.cmml"><mo id="S2.SS2.p3.5.m1.2.2.1.1.1.2" stretchy="false" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.cmml">(</mo><msup id="S2.SS2.p3.5.m1.2.2.1.1.1.1" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.cmml"><mi id="S2.SS2.p3.5.m1.2.2.1.1.1.1.2" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.cmml"><mi id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.2" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.1" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.3" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p3.5.m1.2.2.1.1.1.3" stretchy="false" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.SS2.p3.5.m1.3.3.3" xref="S2.SS2.p3.5.m1.3.3.3.cmml">=</mo><mrow id="S2.SS2.p3.5.m1.3.3.2" xref="S2.SS2.p3.5.m1.3.3.2.cmml"><msub id="S2.SS2.p3.5.m1.3.3.2.3" xref="S2.SS2.p3.5.m1.3.3.2.3.cmml"><mi id="S2.SS2.p3.5.m1.3.3.2.3.2" xref="S2.SS2.p3.5.m1.3.3.2.3.2.cmml">f</mi><msub id="S2.SS2.p3.5.m1.3.3.2.3.3" xref="S2.SS2.p3.5.m1.3.3.2.3.3.cmml"><mi id="S2.SS2.p3.5.m1.3.3.2.3.3.2" xref="S2.SS2.p3.5.m1.3.3.2.3.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p3.5.m1.3.3.2.3.3.3" xref="S2.SS2.p3.5.m1.3.3.2.3.3.3a.cmml">ref</mtext></msub></msub><mo id="S2.SS2.p3.5.m1.3.3.2.2" xref="S2.SS2.p3.5.m1.3.3.2.2.cmml">⁢</mo><mrow id="S2.SS2.p3.5.m1.3.3.2.1.1" xref="S2.SS2.p3.5.m1.3.3.2.1.2.cmml"><mo id="S2.SS2.p3.5.m1.3.3.2.1.1.2" stretchy="false" xref="S2.SS2.p3.5.m1.3.3.2.1.2.cmml">(</mo><mi id="S2.SS2.p3.5.m1.1.1" xref="S2.SS2.p3.5.m1.1.1.cmml">x</mi><mo id="S2.SS2.p3.5.m1.3.3.2.1.1.3" xref="S2.SS2.p3.5.m1.3.3.2.1.2.cmml">,</mo><msup id="S2.SS2.p3.5.m1.3.3.2.1.1.1" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.cmml"><mi id="S2.SS2.p3.5.m1.3.3.2.1.1.1.2" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.cmml"><mi id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.2" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.1" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.3" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p3.5.m1.3.3.2.1.1.4" stretchy="false" xref="S2.SS2.p3.5.m1.3.3.2.1.2.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.5.m1.3b"><apply id="S2.SS2.p3.5.m1.3.3.cmml" xref="S2.SS2.p3.5.m1.3.3"><eq id="S2.SS2.p3.5.m1.3.3.3.cmml" xref="S2.SS2.p3.5.m1.3.3.3"></eq><apply id="S2.SS2.p3.5.m1.2.2.1.cmml" xref="S2.SS2.p3.5.m1.2.2.1"><times id="S2.SS2.p3.5.m1.2.2.1.2.cmml" xref="S2.SS2.p3.5.m1.2.2.1.2"></times><ci id="S2.SS2.p3.5.m1.2.2.1.3.cmml" xref="S2.SS2.p3.5.m1.2.2.1.3">𝑚</ci><apply id="S2.SS2.p3.5.m1.2.2.1.1.1.1.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.5.m1.2.2.1.1.1.1.1.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1">superscript</csymbol><ci id="S2.SS2.p3.5.m1.2.2.1.1.1.1.2.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.2">𝑦</ci><apply id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3"><lt id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.1.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.2.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.3.cmml" xref="S2.SS2.p3.5.m1.2.2.1.1.1.1.3.3">𝑡</ci></apply></apply></apply><apply id="S2.SS2.p3.5.m1.3.3.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2"><times id="S2.SS2.p3.5.m1.3.3.2.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.2"></times><apply id="S2.SS2.p3.5.m1.3.3.2.3.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3"><csymbol cd="ambiguous" id="S2.SS2.p3.5.m1.3.3.2.3.1.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3">subscript</csymbol><ci id="S2.SS2.p3.5.m1.3.3.2.3.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3.2">𝑓</ci><apply id="S2.SS2.p3.5.m1.3.3.2.3.3.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3.3"><csymbol cd="ambiguous" id="S2.SS2.p3.5.m1.3.3.2.3.3.1.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3.3">subscript</csymbol><ci id="S2.SS2.p3.5.m1.3.3.2.3.3.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3.3.2">𝜋</ci><ci id="S2.SS2.p3.5.m1.3.3.2.3.3.3a.cmml" xref="S2.SS2.p3.5.m1.3.3.2.3.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.SS2.p3.5.m1.3.3.2.3.3.3.cmml" mathsize="50%" xref="S2.SS2.p3.5.m1.3.3.2.3.3.3">ref</mtext></ci></apply></apply><interval closure="open" id="S2.SS2.p3.5.m1.3.3.2.1.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1"><ci id="S2.SS2.p3.5.m1.1.1.cmml" xref="S2.SS2.p3.5.m1.1.1">𝑥</ci><apply id="S2.SS2.p3.5.m1.3.3.2.1.1.1.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.5.m1.3.3.2.1.1.1.1.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1">superscript</csymbol><ci id="S2.SS2.p3.5.m1.3.3.2.1.1.1.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.2">𝑦</ci><apply id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3"><lt id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.1.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.2.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.3.cmml" xref="S2.SS2.p3.5.m1.3.3.2.1.1.1.3.3">𝑡</ci></apply></apply></interval></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.5.m1.3c">m(y^{&lt;t})=f_{\pi_{\text{ref}}}(x,y^{&lt;t})</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.5.m1.3d">italic_m ( italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) = italic_f start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.5.3">, we end up with the below optimal policy (refer to Appendix </span><a class="ltx_ref ltx_font_typewriter" href="https://arxiv.org/html/2410.05102v1#A1.SS1" title="A.1 Obtaining the Optimal Policy ‣ Appendix A Mathematical Derivations ‣ SparsePO: Controlling Preference Alignment of LLMs via Sparse Token Masks"><span class="ltx_text ltx_ref_tag">A.1</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.5.4"> for a detailed solution),</span></p>
<table class="ltx_equation ltx_eqn_table" id="S2.E4">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\pi^{*}(y^{t}|x,y^{<t})=\frac{1}{Z(x,y^{<t})}\pi_{\text{ref}}(y^{t}|x,y^{<t})%
\exp\left(\frac{1}{\beta\;m(y^{<t})}Q_{\pi_{\text{ref}}}(y^{t}|x,y^{<t})\right)," class="ltx_Math" display="block" id="S2.E4.m1.8"><semantics id="S2.E4.m1.8a"><mrow id="S2.E4.m1.8.8.1" xref="S2.E4.m1.8.8.1.1.cmml"><mrow id="S2.E4.m1.8.8.1.1" xref="S2.E4.m1.8.8.1.1.cmml"><mrow id="S2.E4.m1.8.8.1.1.1" xref="S2.E4.m1.8.8.1.1.1.cmml"><msup id="S2.E4.m1.8.8.1.1.1.3" xref="S2.E4.m1.8.8.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.1.3.2.cmml">π</mi><mo id="S2.E4.m1.8.8.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.1.3.3.cmml">∗</mo></msup><mo id="S2.E4.m1.8.8.1.1.1.2" xref="S2.E4.m1.8.8.1.1.1.2.cmml">⁢</mo><mrow id="S2.E4.m1.8.8.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.1.1.1.1.cmml"><mo id="S2.E4.m1.8.8.1.1.1.1.1.2" stretchy="false" xref="S2.E4.m1.8.8.1.1.1.1.1.1.cmml">(</mo><mrow id="S2.E4.m1.8.8.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.1.1.1.1.cmml"><msup id="S2.E4.m1.8.8.1.1.1.1.1.1.3" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.1.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3.2.cmml">y</mi><mi id="S2.E4.m1.8.8.1.1.1.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3.3.cmml">t</mi></msup><mo fence="false" id="S2.E4.m1.8.8.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.1.1.1.1.2.cmml">|</mo><mrow id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.2.cmml"><mi id="S2.E4.m1.4.4" xref="S2.E4.m1.4.4.cmml">x</mi><mo id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.2.cmml">,</mo><msup id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.cmml"><mi id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.1" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup></mrow></mrow><mo id="S2.E4.m1.8.8.1.1.1.1.1.3" stretchy="false" xref="S2.E4.m1.8.8.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.E4.m1.8.8.1.1.4" xref="S2.E4.m1.8.8.1.1.4.cmml">=</mo><mrow id="S2.E4.m1.8.8.1.1.3" xref="S2.E4.m1.8.8.1.1.3.cmml"><mfrac id="S2.E4.m1.2.2" xref="S2.E4.m1.2.2.cmml"><mn id="S2.E4.m1.2.2.4" xref="S2.E4.m1.2.2.4.cmml">1</mn><mrow id="S2.E4.m1.2.2.2" xref="S2.E4.m1.2.2.2.cmml"><mi id="S2.E4.m1.2.2.2.4" xref="S2.E4.m1.2.2.2.4.cmml">Z</mi><mo id="S2.E4.m1.2.2.2.3" xref="S2.E4.m1.2.2.2.3.cmml">⁢</mo><mrow id="S2.E4.m1.2.2.2.2.1" xref="S2.E4.m1.2.2.2.2.2.cmml"><mo id="S2.E4.m1.2.2.2.2.1.2" stretchy="false" xref="S2.E4.m1.2.2.2.2.2.cmml">(</mo><mi id="S2.E4.m1.1.1.1.1" xref="S2.E4.m1.1.1.1.1.cmml">x</mi><mo id="S2.E4.m1.2.2.2.2.1.3" xref="S2.E4.m1.2.2.2.2.2.cmml">,</mo><msup id="S2.E4.m1.2.2.2.2.1.1" xref="S2.E4.m1.2.2.2.2.1.1.cmml"><mi id="S2.E4.m1.2.2.2.2.1.1.2" xref="S2.E4.m1.2.2.2.2.1.1.2.cmml">y</mi><mrow id="S2.E4.m1.2.2.2.2.1.1.3" xref="S2.E4.m1.2.2.2.2.1.1.3.cmml"><mi id="S2.E4.m1.2.2.2.2.1.1.3.2" xref="S2.E4.m1.2.2.2.2.1.1.3.2.cmml"></mi><mo id="S2.E4.m1.2.2.2.2.1.1.3.1" xref="S2.E4.m1.2.2.2.2.1.1.3.1.cmml">&lt;</mo><mi id="S2.E4.m1.2.2.2.2.1.1.3.3" xref="S2.E4.m1.2.2.2.2.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.E4.m1.2.2.2.2.1.4" stretchy="false" xref="S2.E4.m1.2.2.2.2.2.cmml">)</mo></mrow></mrow></mfrac><mo id="S2.E4.m1.8.8.1.1.3.3" xref="S2.E4.m1.8.8.1.1.3.3.cmml">⁢</mo><msub id="S2.E4.m1.8.8.1.1.3.4" xref="S2.E4.m1.8.8.1.1.3.4.cmml"><mi id="S2.E4.m1.8.8.1.1.3.4.2" xref="S2.E4.m1.8.8.1.1.3.4.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E4.m1.8.8.1.1.3.4.3" xref="S2.E4.m1.8.8.1.1.3.4.3a.cmml">ref</mtext></msub><mo id="S2.E4.m1.8.8.1.1.3.3a" xref="S2.E4.m1.8.8.1.1.3.3.cmml">⁢</mo><mrow id="S2.E4.m1.8.8.1.1.2.1.1" xref="S2.E4.m1.8.8.1.1.2.1.1.1.cmml"><mo id="S2.E4.m1.8.8.1.1.2.1.1.2" stretchy="false" xref="S2.E4.m1.8.8.1.1.2.1.1.1.cmml">(</mo><mrow id="S2.E4.m1.8.8.1.1.2.1.1.1" xref="S2.E4.m1.8.8.1.1.2.1.1.1.cmml"><msup id="S2.E4.m1.8.8.1.1.2.1.1.1.3" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.2.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3.2.cmml">y</mi><mi id="S2.E4.m1.8.8.1.1.2.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3.3.cmml">t</mi></msup><mo fence="false" id="S2.E4.m1.8.8.1.1.2.1.1.1.2" xref="S2.E4.m1.8.8.1.1.2.1.1.1.2.cmml">|</mo><mrow id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.2.cmml"><mi id="S2.E4.m1.5.5" xref="S2.E4.m1.5.5.cmml">x</mi><mo id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.2.cmml">,</mo><msup id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.cmml"><mi id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.1" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup></mrow></mrow><mo id="S2.E4.m1.8.8.1.1.2.1.1.3" stretchy="false" xref="S2.E4.m1.8.8.1.1.2.1.1.1.cmml">)</mo></mrow><mo id="S2.E4.m1.8.8.1.1.3.3b" lspace="0.167em" xref="S2.E4.m1.8.8.1.1.3.3.cmml">⁢</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1" xref="S2.E4.m1.8.8.1.1.3.2.2.cmml"><mi id="S2.E4.m1.7.7" xref="S2.E4.m1.7.7.cmml">exp</mi><mo id="S2.E4.m1.8.8.1.1.3.2.1a" xref="S2.E4.m1.8.8.1.1.3.2.2.cmml">⁡</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1" xref="S2.E4.m1.8.8.1.1.3.2.2.cmml"><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.2" xref="S2.E4.m1.8.8.1.1.3.2.2.cmml">(</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.cmml"><mfrac id="S2.E4.m1.3.3" xref="S2.E4.m1.3.3.cmml"><mn id="S2.E4.m1.3.3.3" xref="S2.E4.m1.3.3.3.cmml">1</mn><mrow id="S2.E4.m1.3.3.1" xref="S2.E4.m1.3.3.1.cmml"><mi id="S2.E4.m1.3.3.1.3" xref="S2.E4.m1.3.3.1.3.cmml">β</mi><mo id="S2.E4.m1.3.3.1.2" lspace="0.280em" xref="S2.E4.m1.3.3.1.2.cmml">⁢</mo><mi id="S2.E4.m1.3.3.1.4" xref="S2.E4.m1.3.3.1.4.cmml">m</mi><mo id="S2.E4.m1.3.3.1.2a" xref="S2.E4.m1.3.3.1.2.cmml">⁢</mo><mrow id="S2.E4.m1.3.3.1.1.1" xref="S2.E4.m1.3.3.1.1.1.1.cmml"><mo id="S2.E4.m1.3.3.1.1.1.2" stretchy="false" xref="S2.E4.m1.3.3.1.1.1.1.cmml">(</mo><msup id="S2.E4.m1.3.3.1.1.1.1" xref="S2.E4.m1.3.3.1.1.1.1.cmml"><mi id="S2.E4.m1.3.3.1.1.1.1.2" xref="S2.E4.m1.3.3.1.1.1.1.2.cmml">y</mi><mrow id="S2.E4.m1.3.3.1.1.1.1.3" xref="S2.E4.m1.3.3.1.1.1.1.3.cmml"><mi id="S2.E4.m1.3.3.1.1.1.1.3.2" xref="S2.E4.m1.3.3.1.1.1.1.3.2.cmml"></mi><mo id="S2.E4.m1.3.3.1.1.1.1.3.1" xref="S2.E4.m1.3.3.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.E4.m1.3.3.1.1.1.1.3.3" xref="S2.E4.m1.3.3.1.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.E4.m1.3.3.1.1.1.3" stretchy="false" xref="S2.E4.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow></mfrac><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.2.cmml">⁢</mo><msub id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.2.cmml">Q</mi><msub id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.cmml"><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.2.cmml">π</mi><mtext class="ltx_mathvariant_monospace" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3a.cmml">ref</mtext></msub></msub><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.2a" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.2.cmml">⁢</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.cmml"><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.2" stretchy="false" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.cmml">(</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.cmml"><msup id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.2.cmml">y</mi><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.3.cmml">t</mi></msup><mo fence="false" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.2.cmml">|</mo><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.2.cmml"><mi id="S2.E4.m1.6.6" xref="S2.E4.m1.6.6.cmml">x</mi><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.2.cmml">,</mo><msup id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.cmml"><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.2.cmml">y</mi><mrow id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.2" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.2.cmml"></mi><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.1" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.3" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.3.cmml">t</mi></mrow></msup></mrow></mrow><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.3" stretchy="false" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S2.E4.m1.8.8.1.1.3.2.1.1.3" xref="S2.E4.m1.8.8.1.1.3.2.2.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="S2.E4.m1.8.8.1.2" xref="S2.E4.m1.8.8.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S2.E4.m1.8b"><apply id="S2.E4.m1.8.8.1.1.cmml" xref="S2.E4.m1.8.8.1"><eq id="S2.E4.m1.8.8.1.1.4.cmml" xref="S2.E4.m1.8.8.1.1.4"></eq><apply id="S2.E4.m1.8.8.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.1"><times id="S2.E4.m1.8.8.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.1.2"></times><apply id="S2.E4.m1.8.8.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.1.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.1.3">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.1.3.2">𝜋</ci><times id="S2.E4.m1.8.8.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.1.3.3"></times></apply><apply id="S2.E4.m1.8.8.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1"><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.2">conditional</csymbol><apply id="S2.E4.m1.8.8.1.1.1.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.1.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.1.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3.2">𝑦</ci><ci id="S2.E4.m1.8.8.1.1.1.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.3.3">𝑡</ci></apply><list id="S2.E4.m1.8.8.1.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1"><ci id="S2.E4.m1.4.4.cmml" xref="S2.E4.m1.4.4">𝑥</ci><apply id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3"><lt id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.1.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></list></apply></apply><apply id="S2.E4.m1.8.8.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.3"><times id="S2.E4.m1.8.8.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.3.3"></times><apply id="S2.E4.m1.2.2.cmml" xref="S2.E4.m1.2.2"><divide id="S2.E4.m1.2.2.3.cmml" xref="S2.E4.m1.2.2"></divide><cn id="S2.E4.m1.2.2.4.cmml" type="integer" xref="S2.E4.m1.2.2.4">1</cn><apply id="S2.E4.m1.2.2.2.cmml" xref="S2.E4.m1.2.2.2"><times id="S2.E4.m1.2.2.2.3.cmml" xref="S2.E4.m1.2.2.2.3"></times><ci id="S2.E4.m1.2.2.2.4.cmml" xref="S2.E4.m1.2.2.2.4">𝑍</ci><interval closure="open" id="S2.E4.m1.2.2.2.2.2.cmml" xref="S2.E4.m1.2.2.2.2.1"><ci id="S2.E4.m1.1.1.1.1.cmml" xref="S2.E4.m1.1.1.1.1">𝑥</ci><apply id="S2.E4.m1.2.2.2.2.1.1.cmml" xref="S2.E4.m1.2.2.2.2.1.1"><csymbol cd="ambiguous" id="S2.E4.m1.2.2.2.2.1.1.1.cmml" xref="S2.E4.m1.2.2.2.2.1.1">superscript</csymbol><ci id="S2.E4.m1.2.2.2.2.1.1.2.cmml" xref="S2.E4.m1.2.2.2.2.1.1.2">𝑦</ci><apply id="S2.E4.m1.2.2.2.2.1.1.3.cmml" xref="S2.E4.m1.2.2.2.2.1.1.3"><lt id="S2.E4.m1.2.2.2.2.1.1.3.1.cmml" xref="S2.E4.m1.2.2.2.2.1.1.3.1"></lt><csymbol cd="latexml" id="S2.E4.m1.2.2.2.2.1.1.3.2.cmml" xref="S2.E4.m1.2.2.2.2.1.1.3.2">absent</csymbol><ci id="S2.E4.m1.2.2.2.2.1.1.3.3.cmml" xref="S2.E4.m1.2.2.2.2.1.1.3.3">𝑡</ci></apply></apply></interval></apply></apply><apply id="S2.E4.m1.8.8.1.1.3.4.cmml" xref="S2.E4.m1.8.8.1.1.3.4"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.3.4.1.cmml" xref="S2.E4.m1.8.8.1.1.3.4">subscript</csymbol><ci id="S2.E4.m1.8.8.1.1.3.4.2.cmml" xref="S2.E4.m1.8.8.1.1.3.4.2">𝜋</ci><ci id="S2.E4.m1.8.8.1.1.3.4.3a.cmml" xref="S2.E4.m1.8.8.1.1.3.4.3"><mtext class="ltx_mathvariant_monospace" id="S2.E4.m1.8.8.1.1.3.4.3.cmml" mathsize="70%" xref="S2.E4.m1.8.8.1.1.3.4.3">ref</mtext></ci></apply><apply id="S2.E4.m1.8.8.1.1.2.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1"><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.2.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.2">conditional</csymbol><apply id="S2.E4.m1.8.8.1.1.2.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.2.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.2.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3.2">𝑦</ci><ci id="S2.E4.m1.8.8.1.1.2.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.3.3">𝑡</ci></apply><list id="S2.E4.m1.8.8.1.1.2.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1"><ci id="S2.E4.m1.5.5.cmml" xref="S2.E4.m1.5.5">𝑥</ci><apply id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3"><lt id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.2.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></list></apply><apply id="S2.E4.m1.8.8.1.1.3.2.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1"><exp id="S2.E4.m1.7.7.cmml" xref="S2.E4.m1.7.7"></exp><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1"><times id="S2.E4.m1.8.8.1.1.3.2.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.2"></times><apply id="S2.E4.m1.3.3.cmml" xref="S2.E4.m1.3.3"><divide id="S2.E4.m1.3.3.2.cmml" xref="S2.E4.m1.3.3"></divide><cn id="S2.E4.m1.3.3.3.cmml" type="integer" xref="S2.E4.m1.3.3.3">1</cn><apply id="S2.E4.m1.3.3.1.cmml" xref="S2.E4.m1.3.3.1"><times id="S2.E4.m1.3.3.1.2.cmml" xref="S2.E4.m1.3.3.1.2"></times><ci id="S2.E4.m1.3.3.1.3.cmml" xref="S2.E4.m1.3.3.1.3">𝛽</ci><ci id="S2.E4.m1.3.3.1.4.cmml" xref="S2.E4.m1.3.3.1.4">𝑚</ci><apply id="S2.E4.m1.3.3.1.1.1.1.cmml" xref="S2.E4.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S2.E4.m1.3.3.1.1.1.1.1.cmml" xref="S2.E4.m1.3.3.1.1.1">superscript</csymbol><ci id="S2.E4.m1.3.3.1.1.1.1.2.cmml" xref="S2.E4.m1.3.3.1.1.1.1.2">𝑦</ci><apply id="S2.E4.m1.3.3.1.1.1.1.3.cmml" xref="S2.E4.m1.3.3.1.1.1.1.3"><lt id="S2.E4.m1.3.3.1.1.1.1.3.1.cmml" xref="S2.E4.m1.3.3.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.E4.m1.3.3.1.1.1.1.3.2.cmml" xref="S2.E4.m1.3.3.1.1.1.1.3.2">absent</csymbol><ci id="S2.E4.m1.3.3.1.1.1.1.3.3.cmml" xref="S2.E4.m1.3.3.1.1.1.1.3.3">𝑡</ci></apply></apply></apply></apply><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3">subscript</csymbol><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.2">𝑄</ci><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3">subscript</csymbol><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.2">𝜋</ci><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3a.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3"><mtext class="ltx_mathvariant_monospace" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3.cmml" mathsize="50%" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.3.3.3">ref</mtext></ci></apply></apply><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1"><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.2">conditional</csymbol><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.2">𝑦</ci><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.3.3">𝑡</ci></apply><list id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1"><ci id="S2.E4.m1.6.6.cmml" xref="S2.E4.m1.6.6">𝑥</ci><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1">superscript</csymbol><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.2">𝑦</ci><apply id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3"><lt id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.2">absent</csymbol><ci id="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S2.E4.m1.8.8.1.1.3.2.1.1.1.1.1.1.1.1.1.3.3">𝑡</ci></apply></apply></list></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.E4.m1.8c">\pi^{*}(y^{t}|x,y^{&lt;t})=\frac{1}{Z(x,y^{&lt;t})}\pi_{\text{ref}}(y^{t}|x,y^{&lt;t})%
\exp\left(\frac{1}{\beta\;m(y^{&lt;t})}Q_{\pi_{\text{ref}}}(y^{t}|x,y^{&lt;t})\right),</annotation><annotation encoding="application/x-llamapun" id="S2.E4.m1.8d">italic_π start_POSTSUPERSCRIPT ∗ end_POSTSUPERSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) = divide start_ARG 1 end_ARG start_ARG italic_Z ( italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) end_ARG italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) roman_exp ( divide start_ARG 1 end_ARG start_ARG italic_β italic_m ( italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) end_ARG italic_Q start_POSTSUBSCRIPT italic_π start_POSTSUBSCRIPT ref end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( italic_y start_POSTSUPERSCRIPT italic_t end_POSTSUPERSCRIPT | italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT ) ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(4)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S2.SS2.p3.6"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.6.1">where </span><math alttext="Z(x,y^{<t})" class="ltx_Math" display="inline" id="S2.SS2.p3.6.m1.2"><semantics id="S2.SS2.p3.6.m1.2a"><mrow id="S2.SS2.p3.6.m1.2.2" xref="S2.SS2.p3.6.m1.2.2.cmml"><mi id="S2.SS2.p3.6.m1.2.2.3" xref="S2.SS2.p3.6.m1.2.2.3.cmml">Z</mi><mo id="S2.SS2.p3.6.m1.2.2.2" xref="S2.SS2.p3.6.m1.2.2.2.cmml">⁢</mo><mrow id="S2.SS2.p3.6.m1.2.2.1.1" xref="S2.SS2.p3.6.m1.2.2.1.2.cmml"><mo id="S2.SS2.p3.6.m1.2.2.1.1.2" stretchy="false" xref="S2.SS2.p3.6.m1.2.2.1.2.cmml">(</mo><mi id="S2.SS2.p3.6.m1.1.1" xref="S2.SS2.p3.6.m1.1.1.cmml">x</mi><mo id="S2.SS2.p3.6.m1.2.2.1.1.3" xref="S2.SS2.p3.6.m1.2.2.1.2.cmml">,</mo><msup id="S2.SS2.p3.6.m1.2.2.1.1.1" xref="S2.SS2.p3.6.m1.2.2.1.1.1.cmml"><mi id="S2.SS2.p3.6.m1.2.2.1.1.1.2" xref="S2.SS2.p3.6.m1.2.2.1.1.1.2.cmml">y</mi><mrow id="S2.SS2.p3.6.m1.2.2.1.1.1.3" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.cmml"><mi id="S2.SS2.p3.6.m1.2.2.1.1.1.3.2" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.2.cmml"></mi><mo id="S2.SS2.p3.6.m1.2.2.1.1.1.3.1" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.1.cmml">&lt;</mo><mi id="S2.SS2.p3.6.m1.2.2.1.1.1.3.3" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.3.cmml">t</mi></mrow></msup><mo id="S2.SS2.p3.6.m1.2.2.1.1.4" stretchy="false" xref="S2.SS2.p3.6.m1.2.2.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S2.SS2.p3.6.m1.2b"><apply id="S2.SS2.p3.6.m1.2.2.cmml" xref="S2.SS2.p3.6.m1.2.2"><times id="S2.SS2.p3.6.m1.2.2.2.cmml" xref="S2.SS2.p3.6.m1.2.2.2"></times><ci id="S2.SS2.p3.6.m1.2.2.3.cmml" xref="S2.SS2.p3.6.m1.2.2.3">𝑍</ci><interval closure="open" id="S2.SS2.p3.6.m1.2.2.1.2.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1"><ci id="S2.SS2.p3.6.m1.1.1.cmml" xref="S2.SS2.p3.6.m1.1.1">𝑥</ci><apply id="S2.SS2.p3.6.m1.2.2.1.1.1.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1"><csymbol cd="ambiguous" id="S2.SS2.p3.6.m1.2.2.1.1.1.1.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1">superscript</csymbol><ci id="S2.SS2.p3.6.m1.2.2.1.1.1.2.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1.2">𝑦</ci><apply id="S2.SS2.p3.6.m1.2.2.1.1.1.3.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3"><lt id="S2.SS2.p3.6.m1.2.2.1.1.1.3.1.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.1"></lt><csymbol cd="latexml" id="S2.SS2.p3.6.m1.2.2.1.1.1.3.2.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.2">absent</csymbol><ci id="S2.SS2.p3.6.m1.2.2.1.1.1.3.3.cmml" xref="S2.SS2.p3.6.m1.2.2.1.1.1.3.3">𝑡</ci></apply></apply></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S2.SS2.p3.6.m1.2c">Z(x,y^{&lt;t})</annotation><annotation encoding="application/x-llamapun" id="S2.SS2.p3.6.m1.2d">italic_Z ( italic_x , italic_y start_POSTSUPERSCRIPT &lt; italic_t end_POSTSUPERSCRIPT )</annotation></semantics></math><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p3.6.2"> is the partition function.</span></p>
</div>
<div class="ltx_para ltx_noindent" id="S2.SS2.p4">
<p class="ltx_p" id="S2.SS2.p4.9"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.1">The Bradley-Terry model&nbsp;</span><cite class="ltx_cite ltx_citemacro_citep"><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.2.1">(</span><span class="ltx_text ltx_font_typewriter">Bradley &amp; Terry</span><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.3.2.1.1">, </span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib6" title=""><span class="ltx_text ltx_font_typewriter">1952</span></a><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.4.3">)</span></cite><span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.5"> is a popular theoretical formula employed to model the human preference distribution. As it operates on the sequence-level, its equivalent to the token-level is the Regret Preference model as previously proven by </span><cite class="ltx_cite ltx_citemacro_citet"><span class="ltx_text ltx_font_typewriter">Zeng et&nbsp;al.</span> <span class="ltx_text ltx_font_typewriter" id="S2.SS2.p4.9.6.1.1.1">(</span><a class="ltx_ref" href="https://arxiv.org/html/2410.05102v1#bib.bib37" title=""></a></cite></p></div></section></section></article></div></div></body></html>